<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>

    <!-- ===== PWA Meta Tags ===== -->
    <meta name="application-name" content="ALFARAH">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ALFARAH">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f1419">
    <meta name="msapplication-TileColor" content="#C9A961">
    <meta name="msapplication-navbutton-color" content="#0f1419">
    <meta name="format-detection" content="telephone=no">

    <!-- ===== PWA Manifest (inline) ===== -->
    <script>
        // Ø¥Ù†Ø´Ø§Ø¡ manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        const manifest = {
            name: "ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹",
            short_name: "ALFARAH",
            description: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©",
            start_url: "./",
            display: "standalone",
            orientation: "portrait",
            background_color: "#0f1419",
            theme_color: "#0f1419",
            lang: "ar",
            dir: "rtl",
            icons: [
                {
                    src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%230f1419'/><rect x='16' y='16' width='160' height='160' rx='24' fill='%23C9A961' opacity='0.15'/><text x='96' y='115' text-anchor='middle' font-family='Arial,sans-serif' font-weight='900' font-size='56' fill='%23C9A961'>AL</text></svg>`),
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%230f1419'/><rect x='40' y='40' width='432' height='432' rx='60' fill='%23C9A961' opacity='0.15'/><text x='256' y='310' text-anchor='middle' font-family='Arial,sans-serif' font-weight='900' font-size='150' fill='%23C9A961'>AL</text></svg>`),
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        });
    </script>

    <!-- Apple Touch Icon (SVG inline as data URI) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%230f1419'/%3E%3Crect x='10' y='10' width='160' height='160' rx='30' fill='%23C9A961' opacity='0.2'/%3E%3Ctext x='90' y='108' text-anchor='middle' font-family='Arial' font-weight='900' font-size='52' fill='%23C9A961'%3EAL%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230f1419'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-family='Arial' font-weight='900' font-size='22' fill='%23C9A961'%3EAL%3C/text%3E%3C/svg%3E">
    
    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ“‹ Ø§Ù„Ø²ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„: 210 Ø¯Ø§Ø± - 10 Ø¨Ù„ÙˆÙƒØ§Øª
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: 148 Ø¯Ø§Ø± - 10 Ø¨Ù„ÙˆÙƒØ§Øª
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³: 289 Ø¯Ø§Ø± - 13 Ø¨Ù„ÙˆÙƒ
    
    ğŸ”§ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©: 11 Ø¹Ù…Ù„
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©: 9 Ø£Ø¹Ù…Ø§Ù„
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©: 9 Ø£Ø¹Ù…Ø§Ù„
    
    ğŸ‘¥ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:
       â€¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (admin): ali / 112123
       â€¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (manager): Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
       â€¢ Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹ (engineer): ØªØ®ØµØµ ÙˆØ§Ø­Ø¯ + Ø²ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© + Ø¨Ù„ÙˆÙƒØ§Øª Ù…Ø­Ø¯Ø¯Ø© + Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø§Ø±ÙŠØ±
    
    ğŸ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†:
       ğŸ”´ Ø£Ø­Ù…Ø± = Ù„Ù… ÙŠØ¨Ø¯Ø£
       ğŸŸ¡ Ø£ØµÙØ± = Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
       ğŸŸ¢ Ø£Ø®Ø¶Ø± = Ù…Ù†Ø¬Ø²
    
    â° Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª:
       â€¢ Ø£ÙˆÙ„ Ø³Ø§Ø¹Ø©: ØªØºÙŠÙŠØ± Ù…Ø¨Ø§Ø´Ø±
       â€¢ Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©: Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±
    
    â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:
       â€¢ JSONBin API
       â€¢ Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
       â€¢ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª CSV
    
    ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:
       â€¢ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ (3 Ø¹ØµØ±Ø§Ù‹)
       â€¢ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠØ©
       â€¢ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
       â€¢ Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±
    
    ğŸ” Ù…Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:
       â€¢ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ø±
       â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
       â€¢ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
       â€¢ Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø£Ù†Ø´Ø·Ø©
    -->
    
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        :root {
            --primary-gold: #C9A961;
            --dark-blue: #1a3a52;
            --darker-blue: #0f1419;
            --card-bg: #1f2937;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            min-height: 100vh;
        }
        
        .status-not-started { color: #dc2626; }
        .status-in-progress { color: #f59e0b; }
        .status-completed { color: #10b981; }
        
        .bg-status-not-started { background-color: #dc2626; }
        .bg-status-in-progress { background-color: #f59e0b; }
        .bg-status-completed { background-color: #10b981; }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .house-box {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            font-size: 18px;
            color: white;
        }
        
        .house-box:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .house-box {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
        }

        /* ===== Ø²Ø± AL Ø§Ù„Ø°Ù‡Ø¨ÙŠ ===== */
        .al-logo-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: var(--primary-gold);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1100;
            font-weight: 900;
            font-size: 15px;
            color: #111;
            box-shadow: 0 4px 14px rgba(201,169,97,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            letter-spacing: 1px;
        }
        .al-logo-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(201,169,97,0.7);
        }

        /* ===== Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ===== */
        .back-nav-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 48px;
            height: 48px;
            background: rgba(31,41,55,0.92);
            border: 2px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1100;
            font-size: 22px;
            color: white;
            transition: all 0.2s;
        }
        .back-nav-btn:hover {
            background: rgba(201,169,97,0.2);
            border-color: var(--primary-gold);
        }

        /* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ===== */
        .sidebar-panel {
            position: fixed;
            top: 0;
            right: -90px;
            width: 72px;
            height: 100vh;
            background: linear-gradient(180deg, #1a3a52 0%, #0f1419 100%);
            z-index: 1200;
            transition: right 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        .sidebar-panel.open {
            right: 0;
        }
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 1199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .sidebar-header-section {
            padding: 14px 0 10px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        .sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 12px 4px;
            color: #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            position: relative;
        }
        .sidebar-item:hover {
            background: rgba(201,169,97,0.15);
            color: var(--primary-gold);
        }
        .sidebar-item .s-icon {
            font-size: 22px;
            line-height: 1;
        }
        .sidebar-item .s-label {
            font-size: 9px;
            text-align: center;
            line-height: 1.2;
            max-width: 64px;
            word-break: break-word;
            color: #9ca3af;
        }
        .sidebar-item:hover .s-label {
            color: var(--primary-gold);
        }
        .sidebar-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
        }

        /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù†Ø¸ÙŠÙ ===== */
        .clean-header {
            height: 80px;
            position: sticky;
            top: 0;
            z-index: 500;
        }

        @media print {
            .al-logo-btn, .back-nav-btn, .sidebar-panel, .sidebar-overlay, .no-print {
                display: none !important;
            }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute;
                left: 0; top: 0;
                width: 100%;
            }
        }

        /* ===== Ø·Ø¨Ø§Ø¹Ø© A4 ===== */
        @media print {
            @page {
                size: A4;
                margin: 20mm;
            }
            .print-area {
                font-family: 'Cairo', sans-serif;
                color: #000 !important;
                background: white !important;
            }
            .print-area * {
                color: #000 !important;
                background: transparent !important;
                border-color: #ccc !important;
            }
        }

        /* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ù€ PWA ===== */

        /* Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Safe area Ù„Ù„Ù€ iPhone X ÙˆÙ…Ø§ ÙÙˆÙ‚ */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ */
        button {
            touch-action: manipulation;
            cursor: pointer;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 640px) {
            .sidebar-panel {
                width: 80px;
            }
            .al-logo-btn {
                width: 42px;
                height: 42px;
                font-size: 13px;
                top: calc(env(safe-area-inset-top) + 10px);
                right: 12px;
            }
            .back-nav-btn {
                width: 42px;
                height: 42px;
                font-size: 20px;
                top: calc(env(safe-area-inset-top) + 10px);
                left: 12px;
            }
            .house-box {
                width: 44px;
                height: 44px;
                font-size: 13px;
            }
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 640px) {
            .modal-inner {
                max-height: 95vh !important;
                border-radius: 16px 16px 0 0 !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* Ø´Ø§Ø´Ø© ØªØ«Ø¨ÙŠØª PWA */
        #pwa-install-banner {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 16px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a3a52, #0f1419);
            border: 1px solid rgba(201,169,97,0.4);
            border-radius: 16px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: calc(100vw - 32px);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to   { transform: translateX(-50%) translateY(0);     opacity: 1; }
        }
        #pwa-install-banner .pwa-icon {
            width: 44px; height: 44px;
            background: var(--primary-gold);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 14px; color: #111;
            flex-shrink: 0;
        }
        #pwa-install-banner .pwa-text { flex: 1; }
        #pwa-install-banner .pwa-title {
            color: var(--primary-gold);
            font-weight: 700; font-size: 14px;
        }
        #pwa-install-banner .pwa-sub {
            color: #9ca3af; font-size: 11px; margin-top: 2px;
        }
        #pwa-install-banner .pwa-btn {
            background: var(--primary-gold);
            color: #111; font-weight: 700;
            border: none; border-radius: 10px;
            padding: 8px 16px; font-size: 13px;
            cursor: pointer; flex-shrink: 0;
            font-family: 'Cairo', sans-serif;
        }
        #pwa-install-banner .pwa-close {
            color: #6b7280; background: none; border: none;
            font-size: 20px; cursor: pointer; padding: 0 4px;
            line-height: 1; flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆÙ†Ø§Øª ====================
        const ZONES_DATA = {
            1: {
                id: 1,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„",
                color: "#2563eb",
                active: true,
                totalHouses: 210,
                blocks: [
                    { id: 1, number: 1, houses: 22, types: [{ type: "VY", from: 1, to: 22 }] },
                    { id: 2, number: 2, houses: 20, types: [{ type: "VY", houses: [1, 10, 11, 20] }, { type: "VK", houses: [2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14, 15, 16, 17, 18, 19] }] },
                    { id: 3, number: 3, houses: 20, types: [{ type: "VK", from: 1, to: 20 }] },
                    { id: 4, number: 4, houses: 18, types: [{ type: "VY", houses: [1, 9, 10, 18] }, { type: "VK", houses: [2, 3, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 16, 17] }] },
                    { id: 5, number: 5, houses: 28, types: [{ type: "VK", from: 1, to: 28 }] },
                    { id: 6, number: 6, houses: 28, types: [{ type: "VK", from: 1, to: 28 }] },
                    { id: 7, number: 7, houses: 28, types: [{ type: "VK", houses: [1, 14, 15, 24, 28] }, { type: "VR", houses: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 16, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27] }] },
                    { id: 8, number: 8, houses: 24, types: [{ type: "VK", houses: [1, 7] }, { type: "VY", houses: [2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24] }] },
                    { id: 9, number: 9, houses: 14, types: [{ type: "VK", houses: [1, 2] }, { type: "VY", from: 3, to: 14 }] },
                    { id: 10, number: 10, houses: 8, types: [{ type: "VY", from: 1, to: 8 }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            },
            2: {
                id: 2,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ",
                color: "#16a34a",
                active: true,
                totalHouses: 148,
                blocks: [
                    { id: 1, number: 1, houses: 12, types: [{ type: "VY", from: 1, to: 12 }] },
                    { id: 2, number: 2, houses: 18, types: [{ type: "VY", from: 1, to: 18 }] },
                    { id: 3, number: 3, houses: 19, types: [{ type: "VY", from: 1, to: 19 }] },
                    { id: 4, number: 4, houses: 22, types: [{ type: "VY", from: 1, to: 22 }] },
                    { id: 5, number: 5, houses: 16, types: [{ type: "VY", from: 1, to: 16 }] },
                    { id: 6, number: 6, houses: 12, types: [{ type: "VY", from: 1, to: 12 }] },
                    { id: 7, number: 7, houses: 20, types: [{ type: "VY", from: 1, to: 20 }] },
                    { id: 8, number: 8, houses: 15, types: [{ type: "VY", from: 1, to: 15 }] },
                    { id: 9, number: 9, houses: 7, types: [{ type: "VY", from: 1, to: 7 }] },
                    { id: 10, number: 10, houses: 7, types: [{ type: "VY", from: 1, to: 4 }, { type: "VF", from: 5, to: 7 }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            },
            5: {
                id: 5,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³",
                color: "#dc2626",
                active: true,
                totalHouses: 289,
                blocks: [
                    { id: 1, number: 1, houses: 21, types: [{ type: "VK", houses: [1, 2, 3, 20, 21] }, { type: "VT", houses: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19] }] },
                    { id: 2, number: 2, houses: 22, types: [{ type: "VK", from: 1, to: 11 }, { type: "VT", from: 12, to: 22 }] },
                    { id: 3, number: 3, houses: 28, types: [{ type: "VT", from: 1, to: 28 }] },
                    { id: 4, number: 4, houses: 22, types: [{ type: "VT", from: 1, to: 22 }] },
                    { id: 5, number: 5, houses: 26, types: [{ type: "VT", from: 1, to: 26 }] },
                    { id: 6, number: 6, houses: 26, types: [{ type: "VT", from: 1, to: 26 }] },
                    { id: 7, number: 7, houses: 18, types: [{ type: "VK", from: 1, to: 8 }, { type: "VT", from: 9, to: 18 }] },
                    { id: 8, number: 8, houses: 24, types: [{ type: "VK", houses: [1, 2, 23, 24] }, { type: "VT", houses: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] }] },
                    { id: 9, number: 9, houses: 22, types: [{ type: "VT", from: 1, to: 22 }] },
                    { id: 10, number: 10, houses: 20, types: [{ type: "VT", from: 1, to: 20 }] },
                    { id: 11, number: 11, houses: 21, types: [{ type: "VK", from: 1, to: 3 }, { type: "VT", from: 4, to: 21 }] },
                    { id: 12, number: 12, houses: 15, types: [{ type: "VK", houses: [1, 2, 3, 14, 15] }, { type: "VT", houses: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13] }] },
                    { id: 13, number: 13, houses: 24, types: [{ type: "VK", houses: [1, 2, 23, 24] }, { type: "VT", houses: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            }
        };

        // Helper function to get house type
        function getHouseType(zoneId, blockNumber, houseNumber) {
            const zone = ZONES_DATA[zoneId];
            if (!zone) return 'VY';
            
            const block = zone.blocks.find(b => b.number === blockNumber);
            if (!block || !block.types) return 'VY';
            
            for (const typeInfo of block.types) {
                if (typeInfo.from && typeInfo.to) {
                    if (houseNumber >= typeInfo.from && houseNumber <= typeInfo.to) {
                        return typeInfo.type;
                    }
                } else if (typeInfo.houses && typeInfo.houses.includes(houseNumber)) {
                    return typeInfo.type;
                }
            }
            
            return 'VY';
        }

        // ==================== Firebase Realtime Database Sync ====================
        // Firebase Config
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDNzqb_6GRzK6uFxo_Jz8knRYnEIJD9jJA",
            authDomain: "alfarah-9c40c.firebaseapp.com",
            databaseURL: "https://alfarah-9c40c-default-rtdb.firebaseio.com",
            projectId: "alfarah-9c40c",
            storageBucket: "alfarah-9c40c.firebasestorage.app",
            messagingSenderId: "131040315801",
            appId: "1:131040315801:web:fa20190fae22963964ab08",
            measurementId: "G-SDP3E76YNV"
        };

        const DB_URL = FIREBASE_CONFIG.databaseURL;

        class CloudSync {
            constructor() {
                this.lastSyncTime = 0;
                this.syncInProgress = false;
                this.listeners = {};
                console.log('ğŸ”¥ Firebase Realtime Database initialized');
            }

            // ---- Helper: REST API call to Firebase ----
            async fbGet(path) {
                const res = await fetch(`${DB_URL}/${path}.json`);
                if (!res.ok) throw new Error(`Firebase GET failed: ${res.status}`);
                return await res.json();
            }

            async fbSet(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase SET failed: ${res.status}`);
                return await res.json();
            }

            async fbPatch(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase PATCH failed: ${res.status}`);
                return await res.json();
            }

            async fbPush(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase PUSH failed: ${res.status}`);
                return await res.json();
            }

            // ---- Main sync: fetch all data ----
            async syncData() {
                try {
                    console.log('ğŸ“¡ Fetching data from Firebase...');
                    const data = await this.fbGet('alfarah');
                    this.lastSyncTime = Date.now();
                    console.log('âœ… Firebase sync successful');
                    return data || {};
                } catch (error) {
                    console.error('âŒ Firebase syncData error:', error);
                    return null;
                }
            }

            // ---- Save zone data ----
            async saveZoneData(zoneId, zoneData) {
                try {
                    await this.fbSet(`alfarah/zone${zoneId}`, zoneData);
                    console.log(`âœ… Zone ${zoneId} saved to Firebase`);
                } catch (error) {
                    console.error(`âŒ Error saving zone ${zoneId}:`, error);
                }
            }

            // ---- Log activity ----
            async logActivity(activity) {
                try {
                    await this.fbPush('alfarah/activities', { ...activity, _ts: Date.now() });
                    console.log('âœ… Activity logged to Firebase');
                } catch (error) {
                    console.error('âŒ Error logging activity:', error);
                }
            }

            // ---- Log report ----
            async logReport(report) {
                try {
                    await this.fbPush('alfarah/reports', { ...report, _ts: Date.now() });
                    console.log('âœ… Report saved to Firebase');
                } catch (error) {
                    console.error('âŒ Error saving report:', error);
                }
            }

            // ---- Log approval request ----
            async logApprovalRequest(request) {
                try {
                    await this.fbPush('alfarah/approvalRequests', { ...request, _ts: Date.now() });
                    console.log('âœ… Approval request saved to Firebase');
                } catch (error) {
                    console.error('âŒ Error saving approval request:', error);
                }
            }

            // ---- Save users ----
            async saveUsers(users) {
                try {
                    console.log('ğŸ’¾ Saving users to Firebase...');
                    await this.fbSet('alfarah/users', users);
                    console.log('âœ… Users saved to Firebase');
                    alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase!\n\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${users.length}\n\nÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²`);
                } catch (error) {
                    console.error('âŒ Error saving users:', error);
                    alert('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Firebase');
                }
            }

            // ---- Upload full data (compatibility) ----
            async uploadFullData(data) {
                try {
                    await this.fbSet('alfarah', data);
                    this.lastSyncTime = Date.now();
                    console.log('âœ… Full data uploaded to Firebase');
                    return true;
                } catch (error) {
                    console.error('âŒ uploadFullData error:', error);
                    return false;
                }
            }

            // ---- Real-time listener for a zone ----
            startZoneListener(zoneId, callback) {
                // Use Server-Sent Events (Firebase REST streaming)
                const url = `${DB_URL}/alfarah/zone${zoneId}.json?accept=text/event-stream`;
                try {
                    const evtSource = new EventSource(url);
                    evtSource.addEventListener('put', (e) => {
                        try {
                            const parsed = JSON.parse(e.data);
                            if (parsed && parsed.data) {
                                console.log(`ğŸ”” Firebase: Zone ${zoneId} updated in real-time`);
                                callback(parsed.data);
                            }
                        } catch (err) {
                            console.error('SSE parse error:', err);
                        }
                    });
                    evtSource.onerror = (err) => {
                        console.warn(`âš ï¸ SSE zone${zoneId} error, will retry`, err);
                    };
                    this.listeners[`zone${zoneId}`] = evtSource;
                    console.log(`ğŸ‘‚ Listening for real-time updates on Zone ${zoneId}`);
                } catch (e) {
                    console.warn('EventSource not supported, using polling');
                }
            }

            stopZoneListener(zoneId) {
                const key = `zone${zoneId}`;
                if (this.listeners[key]) {
                    this.listeners[key].close();
                    delete this.listeners[key];
                }
            }

            // ---- Export CSV ----
            async exportData() {
                try {
                    const data = await this.syncData();
                    if (data) {
                        let csv = '\ufeffØ§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø²ÙˆÙ†,Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…,Ø§Ù„Ù‚Ø³Ù…,Ø§Ù„Ø¹Ù…Ù„,Ø§Ù„Ø¨Ù„ÙˆÙƒ,Ø§Ù„Ø¨ÙŠØª,Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©,Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n';
                        
                        if (data.activities) {
                            // Firebase returns object with keys, convert to array
                            const acts = typeof data.activities === 'object' && !Array.isArray(data.activities)
                                ? Object.values(data.activities)
                                : data.activities;
                            acts.forEach(activity => {
                                csv += `${activity.timestamp},${activity.zoneName},${activity.username},${activity.department},${activity.task},${activity.block},${activity.house},${activity.oldStatus},${activity.newStatus}\n`;
                            });
                        }

                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `ALFARAH_Data_${new Date().toISOString().split('T')[0]}.csv`;
                        link.click();
                        return true;
                    }
                } catch (error) {
                    console.error('Error exporting data:', error);
                }
                return false;
            }
        }

        const cloudSync = new CloudSync();

        // ==================== Data Manager ====================
        class DataManager {
            constructor(zoneId = 2) {
                this.zoneId = zoneId;
                this.data = {};
                this.activityLog = [];
                this.editTimes = {};
                this.reportDraft = null;
                this.reportHistory = [];
                this.loadData();
            }

            async setZone(zoneId) {
                this.zoneId = zoneId;
                await this.loadData();
            }

            getZoneData() {
                return ZONES_DATA[this.zoneId];
            }

            async loadData() {
                // Load from localStorage first
                const zoneData = localStorage.getItem(`zone${this.zoneId}_data_v2`);
                const activityLog = localStorage.getItem(`zone${this.zoneId}_activity_log_v2`);
                const editTimes = localStorage.getItem(`zone${this.zoneId}_edit_times`);
                const reportDraft = localStorage.getItem(`zone${this.zoneId}_daily_report_draft`);
                const reportHistory = localStorage.getItem(`zone${this.zoneId}_report_history`);

                this.data = zoneData ? JSON.parse(zoneData) : {};
                this.activityLog = activityLog ? JSON.parse(activityLog) : [];
                this.editTimes = editTimes ? JSON.parse(editTimes) : {};
                this.reportDraft = reportDraft ? JSON.parse(reportDraft) : null;
                this.reportHistory = reportHistory ? JSON.parse(reportHistory) : [];
                
                // Then sync from cloud
                await this.syncFromCloud();
            }

            async syncFromCloud() {
                try {
                    const cloudData = await cloudSync.syncData();
                    if (!cloudData) return;

                    const zoneKey = `zone${this.zoneId}`;
                    if (cloudData[zoneKey]) {
                        const cz = cloudData[zoneKey];
                        
                        // Firebase ÙŠØ£Ø®Ø° Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ localStorage
                        if (cz.data && Object.keys(cz.data).length > 0) {
                            this.data = cz.data;
                        }
                        if (cz.editTimes && Object.keys(cz.editTimes).length > 0) {
                            this.editTimes = cz.editTimes;
                        }
                        if (cz.activityLog) {
                            const arr = Array.isArray(cz.activityLog) 
                                ? cz.activityLog 
                                : Object.values(cz.activityLog);
                            this.activityLog = arr.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                        }
                        
                        // Ø­ÙØ¸ ÙÙŠ localStorage Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
                        localStorage.setItem(`zone${this.zoneId}_data_v2`, JSON.stringify(this.data));
                        localStorage.setItem(`zone${this.zoneId}_activity_log_v2`, JSON.stringify(this.activityLog));
                        localStorage.setItem(`zone${this.zoneId}_edit_times`, JSON.stringify(this.editTimes));
                        console.log(`âœ… Synced zone ${this.zoneId} from Firebase`);
                    }
                    
                    if (cloudData.reports) {
                        const arr = Array.isArray(cloudData.reports) 
                            ? cloudData.reports 
                            : Object.values(cloudData.reports);
                        const zr = arr.filter(r => r && r.zoneId === this.zoneId);
                        if (zr.length > 0) {
                            const ed = new Set(this.reportHistory.map(r => r.submittedAt));
                            const nr = zr.filter(r => !ed.has(r.submittedAt));
                            if (nr.length > 0) {
                                this.reportHistory = [...nr, ...this.reportHistory];
                                localStorage.setItem(`zone${this.zoneId}_report_history`, JSON.stringify(this.reportHistory));
                            }
                        }
                    }
                    
                    if (cloudData.approvalRequests) {
                        const arr = Array.isArray(cloudData.approvalRequests) 
                            ? cloudData.approvalRequests 
                            : Object.values(cloudData.approvalRequests);
                        localStorage.setItem('approval_requests', JSON.stringify(arr));
                    }
                    
                    if (cloudData.users && Array.isArray(cloudData.users) && cloudData.users.length > 0) {
                        localStorage.setItem('alfarah_users', JSON.stringify(cloudData.users));
                        console.log(`âœ… Synced ${cloudData.users.length} users from Firebase`);
                    }
                } catch (error) {
                    console.error('Error syncing from Firebase:', error);
                }
            }

            saveData() {
                // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
                localStorage.setItem(`zone${this.zoneId}_data_v2`, JSON.stringify(this.data));
                localStorage.setItem(`zone${this.zoneId}_activity_log_v2`, JSON.stringify(this.activityLog));
                localStorage.setItem(`zone${this.zoneId}_edit_times`, JSON.stringify(this.editTimes));
                
                // Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase
                cloudSync.saveZoneData(this.zoneId, {
                    data: this.data,
                    activityLog: this.activityLog,
                    editTimes: this.editTimes,
                    _lastUpdated: Date.now()
                });
            }

            getStatus(blockId, houseId, department, taskId) {
                const key = `${blockId}-${houseId}-${department}-${taskId}`;
                return this.data[key] || 'not-started';
            }

            canEditDirectly(blockId, houseId, department, taskId) {
                const key = `${blockId}-${houseId}-${department}-${taskId}`;
                const editTime = this.editTimes[key];
                
                if (!editTime) return true;
                
                const now = new Date().getTime();
                const timeDiff = now - editTime;
                const oneHour = 60 * 60 * 1000;
                
                return timeDiff < oneHour;
            }

            updateStatus(blockId, houseId, department, taskId, newStatus, username, userRole) {
                const key = `${blockId}-${houseId}-${department}-${taskId}`;
                const oldStatus = this.data[key] || 'not-started';
                
                if (oldStatus === newStatus) return;

                // ØªÙ‚Ø¯Ù… = Ù„Ø§ Ù…ÙˆØ§ÙÙ‚Ø©ØŒ ØªØ±Ø§Ø¬Ø¹ = Ù…ÙˆØ§ÙÙ‚Ø©
                const rank = { 'not-started': 0, 'in-progress': 1, 'completed': 2 };
                const isRegression = rank[newStatus] < rank[oldStatus];

                if (isRegression && userRole === 'engineer') {
                    const request = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        timestampDisplay: new Date().toLocaleString('ar-EG'),
                        username,
                        zoneName: this.getZoneData().name,
                        zoneId: this.zoneId,
                        block: blockId,
                        house: houseId,
                        department: department,
                        departmentName: this.getDepartmentName(department),
                        task: taskId,
                        taskName: this.getTaskName(department, taskId),
                        oldStatus: oldStatus,
                        newStatus: newStatus,
                        oldStatusText: this.getStatusText(oldStatus),
                        newStatusText: this.getStatusText(newStatus),
                        status: 'pending'
                    };
                    const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                    requests.unshift(request);
                    localStorage.setItem('approval_requests', JSON.stringify(requests));
                    cloudSync.logApprovalRequest(request);
                    return 'approval-needed';
                }

                this.data[key] = newStatus;
                this.editTimes[key] = new Date().getTime();
                
                const activity = {
                    timestamp: new Date().toISOString(),
                    timestampDisplay: new Date().toLocaleString('ar-EG'),
                    username,
                    zoneName: this.getZoneData().name,
                    block: blockId,
                    house: houseId,
                    department: this.getDepartmentName(department),
                    task: this.getTaskName(department, taskId),
                    oldStatus: this.getStatusText(oldStatus),
                    newStatus: this.getStatusText(newStatus)
                };
                
                this.activityLog.unshift(activity);
                this.saveData();
                
                console.log('âœ… Activity saved:', activity);
                console.log('ğŸ“Š Total activities in log:', this.activityLog.length);
                
                // Send to Cloud
                cloudSync.logActivity(activity);
                
                return 'success';
            }
            
            approveRequest(requestId) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                const request = requests.find(r => r.id === requestId);
                
                if (!request) return false;
                
                // Apply the change
                const key = `${request.block}-${request.house}-${request.department}-${request.task}`;
                this.data[key] = request.newStatus;
                this.editTimes[key] = new Date().getTime();
                
                // Log activity
                const activity = {
                    timestamp: new Date().toISOString(),
                    timestampDisplay: new Date().toLocaleString('ar-EG'),
                    username: request.username,
                    zoneName: request.zoneName,
                    block: request.block,
                    house: request.house,
                    department: request.departmentName,
                    task: request.taskName,
                    oldStatus: request.oldStatusText,
                    newStatus: request.newStatusText
                };
                
                this.activityLog.unshift(activity);
                this.saveData();
                
                // Update request status
                request.status = 'approved';
                request.approvedAt = new Date().toISOString();
                localStorage.setItem('approval_requests', JSON.stringify(requests));
                
                cloudSync.logActivity(activity);
                
                return true;
            }
            
            rejectRequest(requestId, reason) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                const request = requests.find(r => r.id === requestId);
                
                if (!request) return false;
                
                request.status = 'rejected';
                request.rejectedAt = new Date().toISOString();
                request.rejectionReason = reason;
                
                localStorage.setItem('approval_requests', JSON.stringify(requests));
                
                return true;
            }
            
            getPendingRequests() {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                return requests.filter(r => r.status === 'pending');
            }
            
            getMyRequests(username) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                return requests.filter(r => r.username === username);
            }

            getDepartmentName(deptKey) {
                const zoneData = this.getZoneData();
                return zoneData.departments[deptKey]?.name || deptKey;
            }

            getTaskName(department, taskId) {
                const zoneData = this.getZoneData();
                const dept = zoneData.departments[department];
                
                const task = dept.tasks.find(t => t.id === taskId);
                return task ? task.name : taskId;
            }

            getStatusText(status) {
                const statuses = {
                    'not-started': 'Ù„Ù… ÙŠØ¨Ø¯Ø£',
                    'in-progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²',
                    'completed': 'Ù…Ù†Ø¬Ø²'
                };
                return statuses[status] || status;
            }

            saveDraft(data) {
                this.reportDraft = {
                    ...data,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(`zone${this.zoneId}_daily_report_draft`, JSON.stringify(this.reportDraft));
            }

            submitReport(reportData) {
                const report = {
                    ...reportData,
                    zoneName: this.getZoneData().name,
                    zoneId: this.zoneId,
                    date: new Date().toLocaleDateString('ar-EG'),
                    time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                    submittedAt: new Date().toISOString()
                };

                this.reportHistory.unshift(report);
                localStorage.setItem(`zone${this.zoneId}_report_history`, JSON.stringify(this.reportHistory));
                
                this.reportDraft = null;
                localStorage.removeItem(`zone${this.zoneId}_daily_report_draft`);
                
                // Save to cloud
                cloudSync.logReport(report);
                
                return report;
            }

            isReportSubmittedToday() {
                if (this.reportHistory.length === 0) return false;
                
                const lastReport = this.reportHistory[0];
                const lastReportDate = new Date(lastReport.submittedAt);
                const today = new Date();
                
                return lastReportDate.toDateString() === today.toDateString();
            }

            getTodayChanges() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowTimestamp = tomorrow.getTime();
                
                const zoneName = this.getZoneData().name;
                
                const filtered = this.activityLog.filter(activity => {
                    const activityTime = new Date(activity.timestamp).getTime();
                    return activityTime >= todayTimestamp && 
                           activityTime < tomorrowTimestamp && 
                           activity.zoneName === zoneName;
                });
                
                console.log('ğŸ“Š getTodayChanges called');
                console.log('   Zone:', zoneName);
                console.log('   Total activities:', this.activityLog.length);
                console.log('   Today\'s activities:', filtered.length);
                
                return filtered;
            }
        }

        const dataManager = new DataManager(2);

        // ==================== User Management ====================
        class UserManager {
            constructor() {
                this.users = [];
                this.loadUsers();
            }

            async loadUsers() {
                // Load from localStorage first
                const saved = localStorage.getItem('alfarah_users_v2');
                if (saved) {
                    this.users = JSON.parse(saved);
                } else {
                    this.users = [
                        {
                            id: 1,
                            username: 'ali',
                            password: '112123',
                            name: 'Ø¹Ù„ÙŠ',
                            role: 'admin',
                            hidden: true
                        }
                    ];
                }
                
                // Sync from cloud
                await this.syncFromCloud();
            }
            
            async syncFromCloud() {
                try {
                    console.log('ğŸ”„ Syncing users from cloud...');
                    const cloudData = await cloudSync.syncData();
                    console.log('â˜ï¸ Cloud data received:', cloudData ? 'Yes' : 'No');
                    
                    if (cloudData && cloudData.users) {
                        console.log('ğŸ‘¥ Cloud users count:', cloudData.users.length);
                        console.log('ğŸ‘¥ Cloud users:', cloudData.users.map(u => u.username));
                        
                        // Replace all users with cloud users (except admin)
                        const admin = this.users.find(u => u.username === 'ali');
                        const cloudUsers = cloudData.users.filter(u => u.username !== 'ali');
                        
                        this.users = admin ? [admin, ...cloudUsers] : cloudUsers;
                        
                        localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                        console.log('âœ… Users synced from cloud:', this.users.length);
                        console.log('ğŸ‘¥ Available usernames:', this.users.map(u => u.username));
                    } else {
                        console.log('âš ï¸ No users in cloud, using local only');
                    }
                } catch (error) {
                    console.error('âŒ Error syncing users from cloud:', error);
                }
            }

            saveUsers() {
                localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                console.log('ğŸ’¾ Saving users to cloud...');
                console.log('ğŸ‘¥ Users to save:', this.users.length);
                // Also save to cloud
                cloudSync.saveUsers(this.users);
            }
            
            // Export users as shareable code
            exportUsersCode() {
                const data = btoa(unescape(encodeURIComponent(JSON.stringify(this.users))));
                return data;
            }
            
            // Import users from code
            importUsersCode(code) {
                try {
                    const users = JSON.parse(decodeURIComponent(escape(atob(code))));
                    // Keep admin, merge others
                    const admin = this.users.find(u => u.username === 'ali');
                    const importedUsers = users.filter(u => u.username !== 'ali');
                    
                    this.users = admin ? [admin, ...importedUsers] : importedUsers;
                    localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                    
                    return { success: true, count: importedUsers.length };
                } catch (error) {
                    console.error('Import error:', error);
                    return { success: false, message: 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­' };
                }
            }

            authenticate(username, password) {
                return this.users.find(u => u.username === username && u.password === password);
            }

            addUser(userData) {
                const newUser = {
                    id: Date.now(),
                    ...userData
                };
                this.users.push(newUser);
                this.saveUsers();
                return newUser;
            }

            updatePassword(userId, newPassword) {
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    user.password = newPassword;
                    this.saveUsers();
                    return true;
                }
                return false;
            }

            deleteUser(userId) {
                this.users = this.users.filter(u => u.id !== userId);
                this.saveUsers();
            }

            getVisibleUsers() {
                return this.users.filter(u => !u.hidden);
            }
        }

        const userManager = new UserManager();
        // UserManager will load users asynchronously in LoginScreen

        // ==================== Login Component ====================
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                userManager.loadUsers().catch(e => console.warn('sync:', e));
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                const user = userManager.authenticate(username, password);
                if (user) {
                    localStorage.setItem('alfarah_current_user', JSON.stringify(user));
                    onLogin(user);
                } else {
                    setError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
                        <div className="text-center mb-10">
                            <div style={{
                                width: 72, height: 72,
                                background: 'var(--primary-gold)',
                                borderRadius: 16,
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                margin: '0 auto 16px',
                                fontWeight: 900, fontSize: 22, color: '#111', letterSpacing: 1
                            }}>AL</div>
                            <h1 className="text-3xl font-bold mb-1" style={{ color: 'var(--primary-gold)' }}>ALFARAH</h1>
                            <p className="text-gray-400 text-sm">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-gray-300 mb-2 text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    required
                                    autoFocus
                                />
                            </div>

                            <div>
                                <label className="block text-gray-300 mb-2 text-sm">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    required
                                />
                            </div>

                            {error && (
                                <div className="bg-red-500 bg-opacity-20 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full py-3 rounded-lg font-bold text-gray-900 hover:opacity-90 transition"
                                style={{ backgroundColor: 'var(--primary-gold)' }}
                            >
                                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== Zone Selection ====================
        function ZoneSelection({ onSelectZone, availableZones, currentUser, onLogout, onShowReport, onShowUserManagement, onShowApprovals }) {
            const allZones = [
                { id: 1, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„', color: '#2563eb', active: true, houses: 210, blocks: 10 },
                { id: 2, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', color: '#16a34a', active: true, houses: 148, blocks: 10 },
                { id: 3, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù„Ø«', color: '#9333ea', active: false, houses: 0, blocks: 0 },
                { id: 4, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø¹', color: '#ea580c', active: false, houses: 0, blocks: 0 },
                { id: 5, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³', color: '#dc2626', active: true, houses: 289, blocks: 13 }
            ];
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const pendingCount = dataManager.getPendingRequests().length;
            const zones = availableZones
                ? allZones.filter(z => availableZones.includes(z.id))
                : allZones;

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{ paddingTop: 80 }}>
                    <button className="al-logo-btn no-print" onClick={() => setSidebarOpen(true)}>AL</button>
                    <div className={`sidebar-overlay ${sidebarOpen ? 'active' : ''}`} onClick={() => setSidebarOpen(false)} />
                    <div className={`sidebar-panel ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header-section">
                            <div style={{ color: 'var(--primary-gold)', fontWeight: 900, fontSize: 13, letterSpacing: 1 }}>AL</div>
                        </div>
                        <div className="sidebar-item" onClick={() => setSidebarOpen(false)}>
                            <span className="s-icon">ğŸ—ºï¸</span>
                            <span className="s-label">Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                        </div>
                        {onShowReport && (
                            <div className="sidebar-item" onClick={() => { onShowReport(); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ“Š</span>
                                <span className="s-label">ØªÙ‚Ø§Ø±ÙŠØ±</span>
                            </div>
                        )}
                        {onShowApprovals && (currentUser.role === 'manager' || currentUser.role === 'engineer') && (
                            <div className="sidebar-item" onClick={() => { onShowApprovals(); setSidebarOpen(false); }}>
                                <span className="s-icon">{currentUser.role === 'manager' ? 'âœ‹' : 'ğŸ“'}</span>
                                <span className="s-label">{currentUser.role === 'manager' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Ø·Ù„Ø¨Ø§ØªÙŠ'}</span>
                                {currentUser.role === 'manager' && pendingCount > 0 && <span className="sidebar-badge">{pendingCount}</span>}
                            </div>
                        )}
                        {onShowUserManagement && (currentUser.role === 'admin' || currentUser.role === 'manager') && (
                            <div className="sidebar-item" onClick={() => { onShowUserManagement(); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ‘¥</span>
                                <span className="s-label">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            </div>
                        )}
                        <div style={{ marginTop: 'auto' }}>
                            <div className="sidebar-item" style={{ color: '#ef4444' }} onClick={onLogout}>
                                <span className="s-icon">ğŸšª</span>
                                <span className="s-label" style={{ color: '#ef4444' }}>Ø®Ø±ÙˆØ¬</span>
                            </div>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl">
                        <div className="text-center mb-12">
                            <h1 className="text-5xl font-bold mb-3" style={{ color: 'var(--primary-gold)' }}>ALFARAH</h1>
                            <div className="w-24 h-1 mx-auto mb-4" style={{ backgroundColor: 'var(--primary-gold)' }}></div>
                            <p className="text-gray-300 text-2xl font-light">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {zones.map(zone => (
                                <button
                                    key={zone.id}
                                    onClick={() => zone.active && onSelectZone(zone.id)}
                                    disabled={!zone.active}
                                    className={`group relative overflow-hidden rounded-xl transition-all duration-300 ${
                                        zone.active 
                                            ? 'hover:shadow-2xl hover:-translate-y-1 cursor-pointer' 
                                            : 'cursor-not-allowed'
                                    }`}
                                    style={{ 
                                        backgroundColor: '#1f2937',
                                        border: zone.active ? `2px solid ${zone.color}40` : '2px solid #374151'
                                    }}
                                >
                                    <div 
                                        className="absolute top-0 left-0 right-0 h-1"
                                        style={{ backgroundColor: zone.active ? zone.color : '#6b7280' }}
                                    />
                                    
                                    <div className="p-8">
                                        <div className="flex items-center justify-between mb-6">
                                            <div 
                                                className="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl"
                                                style={{ 
                                                    backgroundColor: zone.active ? `${zone.color}30` : '#37415130',
                                                    border: `2px solid ${zone.active ? zone.color : '#6b7280'}`
                                                }}
                                            >
                                                {zone.id}
                                            </div>
                                            
                                            {zone.active ? (
                                                <div className="px-3 py-1 rounded-full text-xs font-semibold" style={{ 
                                                    backgroundColor: `${zone.color}20`,
                                                    color: zone.color 
                                                }}>
                                                    Ù†Ø´Ø·
                                                </div>
                                            ) : (
                                                <div className="px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-400">
                                                    Ù‚Ø±ÙŠØ¨Ø§Ù‹
                                                </div>
                                            )}
                                        </div>

                                        <h3 className="text-2xl font-bold mb-6" style={{ 
                                            color: zone.active ? '#fff' : '#9ca3af'
                                        }}>
                                            {zone.name}
                                        </h3>

                                        {zone.active && (
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between text-gray-300">
                                                    <span className="text-sm flex items-center gap-2">
                                                        <span className="text-lg">ğŸ—ï¸</span>
                                                        Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª
                                                    </span>
                                                    <span className="font-bold text-white">{zone.blocks}</span>
                                                </div>
                                                <div className="flex items-center justify-between text-gray-300">
                                                    <span className="text-sm flex items-center gap-2">
                                                        <span className="text-lg">ğŸ </span>
                                                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±
                                                    </span>
                                                    <span className="font-bold text-white">{zone.houses}</span>
                                                </div>
                                            </div>
                                        )}

                                        {!zone.active && (
                                            <p className="text-gray-500 text-sm text-center py-4">
                                                Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆÙ† Ù‚Ø±ÙŠØ¨Ø§Ù‹
                                            </p>
                                        )}
                                    </div>

                                    {zone.active && (
                                        <div 
                                            className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                            style={{ 
                                                background: `linear-gradient(135deg, ${zone.color}10 0%, transparent 100%)`
                                            }}
                                        />
                                    )}
                                </button>
                            ))}
                        </div>

                        <div className="mt-12 text-center">
                            <p className="text-gray-400 text-sm">
                                Ø§Ø®ØªØ± Ø§Ù„Ø²ÙˆÙ† Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Main App ====================
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentZone, setCurrentZone] = useState(null);
            const [currentView, setCurrentView] = useState('departments');
            const [selectedDepartment, setSelectedDepartment] = useState(null);
            const [selectedTask, setSelectedTask] = useState(null);
            const [selectedBlock, setSelectedBlock] = useState(null);
            const [showSearch, setShowSearch] = useState(false);
            const [showReport, setShowReport] = useState(false);
            const [showUserManagement, setShowUserManagement] = useState(false);
            const [showApprovals, setShowApprovals] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                if (currentZone) {
                    setIsSyncing(true);
                    dataManager.setZone(currentZone).then(() => {
                        setTimeout(() => {
                            setIsSyncing(false);
                            setCurrentView('departments');
                        }, 500);
                    });
                }
            }, [currentZone]);

            useEffect(() => {
                if (!currentZone) return;
                const syncInterval = setInterval(async () => {
                    try {
                        await dataManager.syncFromCloud();
                        // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                        setZoneData({...dataManager.getZoneData()});
                    } catch (e) {}
                }, 15000);
                return () => clearInterval(syncInterval);
            }, [currentZone]);

            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === 15 && now.getMinutes() === 0) {
                        if (!dataManager.isReportSubmittedToday()) {
                            const todayChanges = dataManager.getTodayChanges();
                            dataManager.submitReport({
                                workers: 0, technicians: 0,
                                totalChanges: todayChanges.length,
                                preparedBy: 'Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ', notes: 'ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ'
                            });
                        }
                    }
                }, 60000);
                return () => clearInterval(interval);
            }, [currentZone]);

            if (!currentUser) return <LoginScreen onLogin={setCurrentUser} />;

            if (!currentZone) {
                let availableZones = null;
                if (currentUser.role === 'engineer') {
                    if (currentUser.assignedZones && currentUser.assignedZones.length > 0) {
                        availableZones = currentUser.assignedZones;
                    } else if (currentUser.assignedZone) {
                        availableZones = [currentUser.assignedZone];
                    }
                }
                return (
                    <>
                        <ZoneSelection
                            onSelectZone={setCurrentZone}
                            availableZones={availableZones}
                            currentUser={currentUser}
                            onLogout={() => setCurrentUser(null)}
                            onShowReport={() => setShowReport(true)}
                            onShowUserManagement={() => setShowUserManagement(true)}
                            onShowApprovals={() => setShowApprovals(true)}
                        />
                        {showReport && <ReportModal currentUser={currentUser} onClose={() => setShowReport(false)} />}
                        {showUserManagement && <UserManagementModal currentUser={currentUser} onClose={() => setShowUserManagement(false)} />}
                        {showApprovals && <ApprovalModal currentUser={currentUser} onClose={() => setShowApprovals(false)} />}
                    </>
                );
            }

            const zoneData = ZONES_DATA[currentZone];
            const pendingCount = dataManager.getPendingRequests().length;

            const handleBackToZones = () => {
                setCurrentZone(null);
                setCurrentView('departments');
                setSelectedDepartment(null);
                setSelectedTask(null);
                setSelectedBlock(null);
                setSidebarOpen(false);
            };

            const handleBackToDepartments = () => {
                setCurrentView('departments');
                setSelectedDepartment(null);
                setSelectedTask(null);
                setSelectedBlock(null);
                setSidebarOpen(false);
            };

            const handleBackToTasks = () => {
                setCurrentView('tasks');
                setSelectedTask(null);
                setSelectedBlock(null);
            };

            const handleBackToBlocks = () => {
                setCurrentView('blocks');
                setSelectedBlock(null);
            };

            // ØªØ­Ø¯ÙŠØ¯ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            const getBackAction = () => {
                if (currentView === 'houses') return handleBackToBlocks;
                if (currentView === 'blocks') return handleBackToTasks;
                if (currentView === 'tasks') return handleBackToDepartments;
                return handleBackToZones;
            };

            return (
                <div className="min-h-screen" style={{ paddingTop: 80 }}>
                    {/* Syncing Overlay */}
                    {isSyncing && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[2000]">
                            <div className="bg-gray-800 p-8 rounded-lg text-center">
                                <div className="flex justify-center mb-4">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
                                </div>
                                <h3 className="text-xl font-bold text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</h3>
                            </div>
                        </div>
                    )}

                    {/* Ø²Ø± AL Ø§Ù„Ø°Ù‡Ø¨ÙŠ */}
                    <button className="al-logo-btn no-print" onClick={() => setSidebarOpen(true)}>AL</button>

                    {/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */}
                    <button className="back-nav-btn no-print" onClick={getBackAction()}>
                        â†
                    </button>

                    {/* Sidebar Overlay */}
                    <div
                        className={`sidebar-overlay ${sidebarOpen ? 'active' : ''}`}
                        onClick={() => setSidebarOpen(false)}
                    />

                    {/* Sidebar */}
                    <div className={`sidebar-panel ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header-section">
                            <div style={{ color: 'var(--primary-gold)', fontWeight: 900, fontSize: 13, letterSpacing: 1 }}>AL</div>
                        </div>

                        <div className="sidebar-item" onClick={handleBackToDepartments}>
                            <span className="s-icon">ğŸ </span>
                            <span className="s-label">Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                        </div>

                        <div className="sidebar-item" onClick={() => { setShowSearch(true); setSidebarOpen(false); }}>
                            <span className="s-icon">ğŸ”</span>
                            <span className="s-label">Ø¨Ø­Ø«</span>
                        </div>

                        <div className="sidebar-item" onClick={() => { setShowReport(true); setSidebarOpen(false); }}>
                            <span className="s-icon">ğŸ“Š</span>
                            <span className="s-label">ØªÙ‚Ø§Ø±ÙŠØ±</span>
                        </div>

                        {(currentUser.role === 'manager' || currentUser.role === 'engineer') && (
                            <div className="sidebar-item" onClick={() => { setShowApprovals(true); setSidebarOpen(false); }}>
                                <span className="s-icon">{currentUser.role === 'manager' ? 'âœ‹' : 'ğŸ“'}</span>
                                <span className="s-label">{currentUser.role === 'manager' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Ø·Ù„Ø¨Ø§ØªÙŠ'}</span>
                                {currentUser.role === 'manager' && pendingCount > 0 && (
                                    <span className="sidebar-badge">{pendingCount}</span>
                                )}
                            </div>
                        )}

                        {(currentUser.role === 'admin' || currentUser.role === 'manager') && (
                            <div className="sidebar-item" onClick={() => { setShowUserManagement(true); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ‘¥</span>
                                <span className="s-label">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            </div>
                        )}

                        <div className="sidebar-item" onClick={handleBackToZones}>
                            <span className="s-icon">ğŸ—ºï¸</span>
                            <span className="s-label">Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                        </div>

                        <div style={{ marginTop: 'auto' }}>
                            <div className="sidebar-item" style={{ color: '#ef4444' }} onClick={() => setCurrentUser(null)}>
                                <span className="s-icon">ğŸšª</span>
                                <span className="s-label" style={{ color: '#ef4444' }}>Ø®Ø±ÙˆØ¬</span>
                            </div>
                        </div>
                    </div>

                    {/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */}
                    <div className="container mx-auto px-4 py-6">
                        {currentView === 'departments' && (
                            <DepartmentsView
                                zoneData={zoneData}
                                currentUser={currentUser}
                                onSelectDepartment={(dept) => {
                                    setSelectedDepartment(dept);
                                    setCurrentView('tasks');
                                }}
                            />
                        )}
                        {currentView === 'tasks' && (
                            <TasksView
                                zoneData={zoneData}
                                department={selectedDepartment}
                                currentUser={currentUser}
                                onSelectTask={(task) => {
                                    setSelectedTask(task);
                                    setCurrentView('blocks');
                                }}
                                onBack={handleBackToDepartments}
                            />
                        )}
                        {currentView === 'blocks' && (
                            <BlocksView
                                zoneData={zoneData}
                                department={selectedDepartment}
                                task={selectedTask}
                                currentUser={currentUser}
                                onSelectBlock={(block) => {
                                    setSelectedBlock(block);
                                    setCurrentView('houses');
                                }}
                                onBack={handleBackToTasks}
                            />
                        )}
                        {currentView === 'houses' && (
                            <HousesView
                                zoneData={zoneData}
                                block={selectedBlock}
                                department={selectedDepartment}
                                task={selectedTask}
                                currentUser={currentUser}
                                onBack={handleBackToBlocks}
                            />
                        )}
                    </div>

                    {showSearch && <SearchModal zoneData={zoneData} onClose={() => setShowSearch(false)} />}
                    {showReport && <ReportModal currentUser={currentUser} onClose={() => setShowReport(false)} />}
                    {showUserManagement && <UserManagementModal currentUser={currentUser} onClose={() => setShowUserManagement(false)} />}
                    {showApprovals && <ApprovalModal currentUser={currentUser} onClose={() => setShowApprovals(false)} />}
                </div>
            );
        }

        // ==================== Departments View ====================
        function DepartmentsView({ zoneData, onSelectDepartment, currentUser }) {
            const getDeptColor = (key) => {
                if (key === 'civil') return '#10b981';
                if (key === 'electrical') return '#f59e0b';
                return '#3b82f6';
            };
            
            // Filter departments based on engineer's specialty
            const departments = currentUser.role === 'engineer' && currentUser.department
                ? { [currentUser.department]: zoneData.departments[currentUser.department] }
                : zoneData.departments;

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="text-center mb-12">
                        <h2 className="text-4xl font-bold text-white mb-3">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</h2>
                        <div className="w-24 h-1 mx-auto" style={{ backgroundColor: 'var(--primary-gold)' }}></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {Object.entries(departments).map(([key, dept]) => (
                            <button
                                key={key}
                                onClick={() => onSelectDepartment(key)}
                                className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 border-gray-700 hover:border-gray-600"
                            >
                                <div 
                                    className="absolute top-0 left-0 right-0 h-1.5"
                                    style={{ backgroundColor: getDeptColor(key) }}
                                />

                                <div className="p-10">
                                    <div className="mb-6">
                                        <div 
                                            className="w-24 h-24 mx-auto rounded-2xl flex items-center justify-center text-5xl mb-4 transition-all duration-300 group-hover:scale-110"
                                            style={{ 
                                                backgroundColor: `${getDeptColor(key)}20`,
                                                border: `3px solid ${getDeptColor(key)}40`
                                            }}
                                        >
                                            {dept.icon}
                                        </div>
                                    </div>

                                    <h2 className="text-2xl font-bold text-white text-center mb-4">
                                        {dept.name}
                                    </h2>

                                    <div className="text-center">
                                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-full">
                                            <span className="text-gray-300 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:</span>
                                            <span className="text-white font-bold">{dept.tasks.length}</span>
                                        </div>
                                    </div>
                                </div>

                                <div 
                                    className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                    style={{ 
                                        background: `linear-gradient(135deg, ${getDeptColor(key)}10 0%, transparent 100%)`
                                    }}
                                />
                            </button>
                        ))}
                    </div>

                    <div className="mt-8 text-center">
                        <p className="text-gray-400 text-sm">
                            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
                        </p>
                    </div>
                </div>
            );
        }

        // ==================== Tasks View ====================
        function TasksView({ zoneData, department, onSelectTask, onBack, currentUser }) {
            const deptData = zoneData.departments[department];

            const getDeptColor = (key) => {
                if (key === 'civil') return '#10b981';
                if (key === 'electrical') return '#f59e0b';
                return '#3b82f6';
            };
            
            // Filter tasks based on engineer's department if applicable
            let tasks = deptData.tasks;
            // If engineer, only show their department tasks (already filtered in DepartmentsView)
            // So no additional filtering needed here

            return (
                <div>
                    <div className="mb-8">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold"
                        >
                            <span>â†</span>
                            <span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>

                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4" style={{ borderColor: getDeptColor(department) }}>
                        <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                            <span className="text-4xl">{deptData.icon}</span>
                            {deptData.name}
                        </h2>
                        <p className="text-gray-400 mt-2">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {deptData.tasks.map((task, idx) => (
                            <button
                                key={task.id}
                                onClick={() => onSelectTask(task)}
                                className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border-2 border-gray-700 hover:border-gray-600 p-6 text-right"
                            >
                                <div className="flex items-start gap-3">
                                    <div 
                                        className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0"
                                        style={{ backgroundColor: getDeptColor(department) }}
                                    >
                                        {idx + 1}
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="text-lg font-bold text-white leading-relaxed">
                                            {task.name}
                                        </h3>
                                    </div>
                                </div>

                                <div 
                                    className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                    style={{ 
                                        background: `linear-gradient(135deg, ${getDeptColor(department)}10 0%, transparent 100%)`
                                    }}
                                />
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // ==================== Blocks View ====================
        function BlocksView({ zoneData, department, task, onSelectBlock, onBack, currentUser }) {
            const deptData = zoneData.departments[department];
            
            // Filter blocks based on engineer's assigned blocks
            let blocks = zoneData.blocks;
            if (currentUser.role === 'engineer') {
                if (currentUser.zoneBlocks && currentUser.zoneBlocks[zoneData.id]) {
                    // New format: multiple zones
                    blocks = zoneData.blocks.filter(b => currentUser.zoneBlocks[zoneData.id].includes(b.number));
                } else if (currentUser.assignedBlocks && currentUser.assignedZone === zoneData.id) {
                    // Old format: single zone
                    blocks = zoneData.blocks.filter(b => currentUser.assignedBlocks.includes(b.number));
                }
            }

            return (
                <div>
                    <div className="mb-8 flex items-center justify-between">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold"
                        >
                            <span>â†</span>
                            <span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>

                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4 border-blue-500">
                        <div className="flex items-center gap-3 mb-2">
                            <span className="text-3xl">{deptData.icon}</span>
                            <h2 className="text-2xl font-bold text-white">
                                {deptData.name}
                            </h2>
                        </div>
                        <p className="text-gray-300 text-lg pr-12">{task.name}</p>
                        <p className="text-gray-400 mt-2 pr-12">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„ÙˆÙƒ</p>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        {blocks.map(block => {
                            let totalHouses = block.houses;
                            let completedHouses = 0;
                            
                            for (let house = 1; house <= block.houses; house++) {
                                const status = dataManager.getStatus(block.number, house, department, task.id);
                                if (status === 'completed') completedHouses++;
                            }
                            
                            const blockProgress = totalHouses > 0 ? Math.round((completedHouses / totalHouses) * 100) : 0;

                            return (
                                <button
                                    key={block.id}
                                    onClick={() => onSelectBlock(block)}
                                    className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border-2 border-gray-700 hover:border-gray-600"
                                >
                                    <div 
                                        className="absolute top-0 left-0 h-1 transition-all duration-500"
                                        style={{ 
                                            width: `${blockProgress}%`,
                                            backgroundColor: blockProgress === 100 ? '#10b981' : blockProgress > 0 ? '#f59e0b' : '#dc2626'
                                        }}
                                    />

                                    <div className="p-6">
                                        <div className="mb-4">
                                            <div className="w-16 h-16 mx-auto rounded-full bg-gray-700 flex items-center justify-center text-3xl mb-3 group-hover:bg-gray-600 transition-colors">
                                                ğŸ—ï¸
                                            </div>
                                            <h3 className="text-xl font-bold text-white text-center">
                                                Ø¨Ù„ÙˆÙƒ {block.number}
                                            </h3>
                                        </div>

                                        <div className="text-center mb-4">
                                            <div className="inline-flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-full">
                                                <span className="text-sm">ğŸ </span>
                                                <span className="text-white text-sm font-semibold">{block.houses} Ø¯Ø§Ø±</span>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                                                <span className="text-white font-bold">{blockProgress}%</span>
                                            </div>
                                            <div className="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                                <div 
                                                    className="h-full rounded-full transition-all duration-500"
                                                    style={{ 
                                                        width: `${blockProgress}%`,
                                                        backgroundColor: blockProgress === 100 ? '#10b981' : blockProgress > 0 ? '#f59e0b' : '#dc2626'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="absolute inset-0 bg-gradient-to-t from-gray-900/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none" />
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ==================== Houses View ====================
        function HousesView({ zoneData, block, department, task, currentUser, onBack }) {
            const [refresh, setRefresh] = useState(0);
            const houses = Array.from({ length: block.houses }, (_, i) => i + 1);

            const getStatusColor = (status) => {
                if (status === 'completed') return '#10b981';
                if (status === 'in-progress') return '#f59e0b';
                return '#dc2626';
            };

            const cycleStatus = (currentStatus) => {
                if (currentStatus === 'not-started') return 'in-progress';
                if (currentStatus === 'in-progress') return 'completed';
                return 'not-started';
            };

            const handleHouseClick = (houseNum) => {
                if (currentUser.role === 'engineer' && currentUser.department && currentUser.department !== department) {
                    alert('â›” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…\nØ§Ø®ØªØµØ§ØµÙƒ: ' + (currentUser.department === 'civil' ? 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©' : currentUser.department === 'electrical' ? 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©' : 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©'));
                    return;
                }
                const currentStatus = dataManager.getStatus(block.number, houseNum, department, task.id);
                const newStatus = cycleStatus(currentStatus);
                
                const result = dataManager.updateStatus(
                    block.number, houseNum, department, task.id,
                    newStatus, currentUser.name, currentUser.role
                );

                if (result === 'approval-needed') {
                    const oldText = currentStatus === 'completed' ? 'Ù…Ù†Ø¬Ø²' : currentStatus === 'in-progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' : 'Ù„Ù… ÙŠØ¨Ø¯Ø£';
                    const newText = newStatus === 'completed' ? 'Ù…Ù†Ø¬Ø²' : newStatus === 'in-progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' : 'Ù„Ù… ÙŠØ¨Ø¯Ø£';
                    alert(`âš ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\n\nØ¨Ù„ÙˆÙƒ ${block.number} - Ø¨ÙŠØª ${houseNum}\n${oldText} â† ${newText}\n\nØ§Ù„ØªØ±Ø§Ø¬Ø¹ ÙŠØ­ØªØ§Ø¬ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±`);
                } else if (result !== 'forbidden') {
                    setRefresh(prev => prev + 1);
                }
            };

            return (
                <div>
                    <div className="mb-8">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold"
                        >
                            <span>â†</span>
                            <span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>
                    
                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4 border-blue-500">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-3xl font-bold text-white mb-2">
                                    Ø¨Ù„ÙˆÙƒ {block.number}
                                </h2>
                                <p className="text-gray-300">{task.name}</p>
                            </div>
                            <div className="text-5xl">ğŸ—ï¸</div>
                        </div>
                        
                        <div className="bg-gray-700 p-4 rounded-lg">
                            <div className="flex items-center gap-4 text-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded" style={{ backgroundColor: '#dc2626' }}></div>
                                    <span className="text-gray-300">Ù„Ù… ÙŠØ¨Ø¯Ø£</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded" style={{ backgroundColor: '#f59e0b' }}></div>
                                    <span className="text-gray-300">Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded" style={{ backgroundColor: '#10b981' }}></div>
                                    <span className="text-gray-300">Ù…Ù†Ø¬Ø²</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-3">
                        {houses.map(houseNum => {
                            const status = dataManager.getStatus(block.number, houseNum, department, task.id);
                            const houseType = getHouseType(zoneData.id, block.number, houseNum);
                            
                            return (
                                <div key={houseNum} className="text-center">
                                    <button
                                        onClick={() => handleHouseClick(houseNum)}
                                        className="house-box"
                                        style={{ 
                                            backgroundColor: getStatusColor(status)
                                        }}
                                        disabled={currentUser.role === 'manager'}
                                    >
                                        {houseNum}
                                    </button>
                                    <div className="text-xs text-gray-400 mt-1">{houseType}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ==================== Search Modal ====================
        function SearchModal({ zoneData, onClose }) {
            const [selectedBlock, setSelectedBlock] = useState('');
            const [houseNumber, setHouseNumber] = useState('');
            const [searchResult, setSearchResult] = useState(null);

            const handleSearch = () => {
                if (!selectedBlock || !houseNumber) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ù„ÙˆÙƒ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª');
                    return;
                }

                const blockNum = parseInt(selectedBlock);
                const houseNum = parseInt(houseNumber);
                const block = zoneData.blocks.find(b => b.number === blockNum);

                if (!block || houseNum < 1 || houseNum > block.houses) {
                    alert('Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª ØºÙŠØ± ØµØ­ÙŠØ­');
                    return;
                }

                const houseType = getHouseType(zoneData.id, blockNum, houseNum);

                const result = {
                    block: blockNum,
                    house: houseNum,
                    type: houseType,
                    details: {}
                };

                Object.entries(zoneData.departments).forEach(([deptKey, dept]) => {
                    result.details[deptKey] = {
                        name: dept.name,
                        icon: dept.icon,
                        tasks: []
                    };

                    dept.tasks.forEach(task => {
                        result.details[deptKey].tasks.push({
                            name: task.name,
                            status: dataManager.getStatus(blockNum, houseNum, deptKey, task.id)
                        });
                    });
                });

                setSearchResult(result);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <h3 className="text-2xl font-bold text-white">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ø±</h3>
                            <button
                                onClick={onClose}
                                className="text-white text-3xl hover:text-red-500 transition"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-white mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„ÙˆÙƒ</label>
                                    <select
                                        value={selectedBlock}
                                        onChange={(e) => setSelectedBlock(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    >
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„ÙˆÙƒ</option>
                                        {zoneData.blocks.map(block => (
                                            <option key={block.id} value={block.number}>
                                                Ø¨Ù„ÙˆÙƒ {block.number}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-white mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª</label>
                                    <input
                                        type="number"
                                        value={houseNumber}
                                        onChange={(e) => setHouseNumber(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª"
                                        min="1"
                                    />
                                </div>
                            </div>

                            <button
                                onClick={handleSearch}
                                className="w-full py-3 rounded-lg font-bold text-gray-900 mb-6"
                                style={{ backgroundColor: 'var(--primary-gold)' }}
                            >
                                Ø¨Ø­Ø«
                            </button>

                            {searchResult && (
                                <div className="bg-gray-700 p-6 rounded-lg">
                                    <div className="mb-6">
                                        <h4 className="text-2xl font-bold text-white mb-2">
                                            Ø¨Ù„ÙˆÙƒ {searchResult.block} - Ø¨ÙŠØª {searchResult.house}
                                        </h4>
                                        <p className="text-gray-300">Ù†ÙˆØ¹: {searchResult.type}</p>
                                    </div>

                                    {Object.entries(searchResult.details).map(([deptKey, dept]) => (
                                        <div key={deptKey} className="mb-6">
                                            <h5 className="text-xl font-bold text-white mb-3 flex items-center gap-2">
                                                {dept.icon} {dept.name}
                                            </h5>
                                            <div className="space-y-2">
                                                {dept.tasks.map((task, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-gray-600 p-3 rounded">
                                                        <span className="text-white">{task.name}</span>
                                                        <span className={`font-bold ${
                                                            task.status === 'completed' ? 'text-green-400' :
                                                            task.status === 'in-progress' ? 'text-yellow-400' :
                                                            'text-red-400'
                                                        }`}>
                                                            {task.status === 'completed' ? 'âœ… Ù…Ù†Ø¬Ø²' :
                                                             task.status === 'in-progress' ? 'ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' :
                                                             'ğŸ”´ Ù„Ù… ÙŠØ¨Ø¯Ø£'}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Report Modal ====================
        function ReportModal({ currentUser, onClose }) {
            const [workers, setWorkers] = useState('');
            const [technicians, setTechnicians] = useState('');
            const [notes, setNotes] = useState('');
            const [timeLeft, setTimeLeft] = useState('');
            const [todayChanges, setTodayChanges] = useState([]);
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [allReports, setAllReports] = useState([]);
            const [allZonesChanges, setAllZonesChanges] = useState([]);
            const [viewingReport, setViewingReport] = useState(null);
            const [isLoadingReports, setIsLoadingReports] = useState(false);

            useEffect(() => {
                if (currentUser.role === 'manager') {
                    loadAllReports();
                    loadAllZonesChanges();
                } else {
                    if (dataManager.reportDraft) {
                        setWorkers(dataManager.reportDraft.workers || '');
                        setTechnicians(dataManager.reportDraft.technicians || '');
                        setNotes(dataManager.reportDraft.notes || '');
                    }
                    updateTodayChanges();
                    setIsSubmitted(dataManager.isReportSubmittedToday());
                }
                const updateTimer = () => {
                    const now = new Date();
                    const deadline = new Date();
                    deadline.setHours(15, 0, 0, 0);
                    if (now > deadline) deadline.setDate(deadline.getDate() + 1);
                    const diff = deadline - now;
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    setTimeLeft(`${h}Ø³ ${m}Ø¯`);
                };
                updateTimer();
                const iv = setInterval(updateTimer, 60000);
                return () => clearInterval(iv);
            }, []);

            const loadAllReports = async () => {
                setIsLoadingReports(true);
                const reports = [];
                const seenKeys = new Set();
                for (const zoneId of [1, 2, 5]) {
                    const zr = localStorage.getItem(`zone${zoneId}_report_history`);
                    if (zr) { try { for (const r of JSON.parse(zr)) { const k = r.submittedAt || (r.date+r.zoneName); if (!seenKeys.has(k)) { seenKeys.add(k); reports.push(r); } } } catch(e) {} }
                }
                try {
                    const cloudData = await cloudSync.syncData();
                    if (cloudData && cloudData.reports) {
                        const arr = typeof cloudData.reports === 'object' && !Array.isArray(cloudData.reports) ? Object.values(cloudData.reports) : cloudData.reports;
                        for (const r of arr) {
                            if (!r) continue;
                            const k = r.submittedAt || (r.date+r.zoneName);
                            if (!seenKeys.has(k)) {
                                seenKeys.add(k); reports.push(r);
                                if (r.zoneId) {
                                    const ex = JSON.parse(localStorage.getItem(`zone${r.zoneId}_report_history`) || '[]');
                                    if (!ex.some(e => e.submittedAt === r.submittedAt)) { ex.unshift(r); localStorage.setItem(`zone${r.zoneId}_report_history`, JSON.stringify(ex)); }
                                }
                            }
                        }
                    }
                } catch(e) { console.warn('Firebase reports fetch error:', e); }
                reports.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                setAllReports(reports);
                setIsLoadingReports(false);
            };

            const loadAllZonesChanges = async () => {
                const today = new Date(); today.setHours(0,0,0,0);
                const todayTs = today.getTime();
                const tomorrowTs = todayTs + 86400000;
                const all = []; const seenTs = new Set();
                for (const zoneId of [1,2,5]) {
                    const raw = localStorage.getItem(`zone${zoneId}_activity_log_v2`);
                    if (raw) { try { for (const a of JSON.parse(raw)) { const t = new Date(a.timestamp).getTime(); if (t >= todayTs && t < tomorrowTs && !seenTs.has(a.timestamp)) { seenTs.add(a.timestamp); all.push(a); } } } catch(e) {} }
                }
                try {
                    const cloudData = await cloudSync.syncData();
                    if (cloudData && cloudData.activities) {
                        const acts = typeof cloudData.activities === 'object' && !Array.isArray(cloudData.activities) ? Object.values(cloudData.activities) : cloudData.activities;
                        for (const a of acts) { if (!a||!a.timestamp) continue; const t = new Date(a.timestamp).getTime(); if (t >= todayTs && t < tomorrowTs && !seenTs.has(a.timestamp)) { seenTs.add(a.timestamp); all.push(a); } }
                    }
                } catch(e) {}
                all.sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
                setAllZonesChanges(all);
            };

            const updateTodayChanges = () => setTodayChanges(dataManager.getTodayChanges());

            const handleSaveDraft = () => {
                dataManager.saveDraft({ workers: parseInt(workers)||0, technicians: parseInt(technicians)||0, notes });
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
            };

            const handleSubmit = () => {
                const changes = dataManager.getTodayChanges();
                setTodayChanges(changes);
                dataManager.submitReport({
                    workers: parseInt(workers)||0,
                    technicians: parseInt(technicians)||0,
                    totalChanges: changes.length,
                    preparedBy: currentUser.name,
                    notes,
                    changes: changes
                });
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
                setIsSubmitted(true);
                if (currentUser.role === 'manager') loadAllReports();
            };

            const getReportChanges = (report) => {
                if (report.changes && report.changes.length > 0) return report.changes;
                if (!report.submittedAt) return [];
                const reportDate = new Date(report.submittedAt);
                const dayStart = new Date(reportDate); dayStart.setHours(0,0,0,0);
                const dayEnd = new Date(reportDate); dayEnd.setHours(23,59,59,999);
                const all = [];
                for (const zoneId of [1,2,5]) {
                    const raw = localStorage.getItem('zone'+zoneId+'_activity_log_v2');
                    if (raw) { try { const log = JSON.parse(raw); for (const a of log) { const t = new Date(a.timestamp).getTime(); if (t >= dayStart.getTime() && t <= dayEnd.getTime()) { if (!report.zoneName || a.zoneName === report.zoneName) all.push(a); } } } catch(e) {} }
                }
                all.sort((a,b) => new Date(a.timestamp)-new Date(b.timestamp));
                return all;
            };
            const getStatusLabel = (s) =>
                s === 'completed' ? 'Ù…Ù†Ø¬Ø²' : s === 'in-progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' : 'Ù„Ù… ÙŠØ¨Ø¯Ø£';

            const printReport = (report, changes) => {
                const printWin = window.open('', '_blank');
                printWin.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl">
                <head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ±</title>
                <style>
                    @page{size:A4;margin:18mm}
                    body{font-family:Arial,sans-serif;color:#000;font-size:13px;direction:rtl}
                    h1{font-size:20px;color:#C9A961;text-align:center;margin:0 0 4px}
                    h2{font-size:13px;color:#555;text-align:center;margin:0 0 12px;font-weight:normal}
                    .line{border-bottom:2px solid #C9A961;margin:0 0 14px}
                    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
                    .meta span{background:#f5f0e8;padding:3px 10px;border-radius:6px;font-size:12px}
                    .stats{display:flex;gap:12px;margin-bottom:16px}
                    .sbox{flex:1;border:1px solid #C9A961;border-radius:8px;padding:8px;text-align:center}
                    .sval{font-size:24px;font-weight:bold;color:#C9A961}
                    .slbl{font-size:11px;color:#666}
                    table{width:100%;border-collapse:collapse;font-size:11px}
                    th{background:#1a3a52;color:white;padding:7px 5px;text-align:right}
                    td{padding:6px 5px;border-bottom:1px solid #eee}
                    tr:nth-child(even){background:#fafafa}
                    .done{color:#16a34a;font-weight:bold}
                    .wip{color:#d97706;font-weight:bold}
                    .no{color:#dc2626;font-weight:bold}
                    .notes{margin-top:14px;border:1px solid #ddd;border-radius:8px;padding:10px;font-size:12px}
                    .footer{margin-top:28px;display:flex;justify-content:space-between}
                    .sign{border-top:1px solid #999;width:170px;padding-top:4px;text-align:center;font-size:12px}
                </style></head><body>
                <h1>ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1>
                <h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                <div class="line"></div>
                <div class="meta">
                    <span>ğŸ“… ${report.date || new Date().toLocaleDateString('ar-IQ')}</span>
                    <span>â° ${report.time || new Date().toLocaleTimeString('ar-IQ')}</span>
                    <span>ğŸ‘¤ ${report.preparedBy || currentUser.name}</span>
                    <span>ğŸ—ï¸ ${report.zoneName || dataManager.getZoneData()?.name || ''}</span>
                </div>
                <div class="stats">
                    <div class="sbox"><div class="sval">${report.workers||0}</div><div class="slbl">ğŸ‘· Ø§Ù„Ø¹Ù…Ø§Ù„</div></div>
                    <div class="sbox"><div class="sval">${report.technicians||0}</div><div class="slbl">ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div></div>
                    <div class="sbox"><div class="sval">${changes.length}</div><div class="slbl">ğŸ“ˆ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</div></div>
                </div>
                <table><thead><tr>
                    <th>#</th><th>Ø§Ù„Ø¨Ù„ÙˆÙƒ</th><th>Ø§Ù„Ø¨ÙŠØª</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ù„</th><th>Ù…Ù†</th><th>Ø¥Ù„Ù‰</th><th>Ø§Ù„ÙˆÙ‚Øª</th>
                </tr></thead><tbody>
                ${changes.map((c,i) => `<tr>
                    <td>${i+1}</td><td>Ø¨Ù„ÙˆÙƒ ${c.block}</td><td>Ø¨ÙŠØª ${c.house}</td>
                    <td>${c.department||''}</td><td>${c.task||''}</td>
                    <td class="${c.oldStatus==='completed'?'done':c.oldStatus==='in-progress'?'wip':'no'}">${getStatusLabel(c.oldStatus)}</td>
                    <td class="${c.newStatus==='completed'?'done':c.newStatus==='in-progress'?'wip':'no'}">${getStatusLabel(c.newStatus)}</td>
                    <td>${c.timestampDisplay||c.timestamp||''}</td>
                </tr>`).join('')}
                ${changes.length===0?'<tr><td colspan="8" style="text-align:center;color:#888;padding:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª</td></tr>':''}
                </tbody></table>
                ${(report.notes||notes)?`<div class="notes"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${report.notes||notes}</div>`:''}
                <div class="footer">
                    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³<br>${report.preparedBy||currentUser.name}</div>
                    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                </div>
                </body></html>`);
                printWin.document.close();
                setTimeout(() => printWin.print(), 400);
            };

            // ===== Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ =====
            if (viewingReport) {
                const changes = getReportChanges(viewingReport);
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-800 p-5 border-b border-gray-700 flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                                    <p className="text-gray-400 text-sm">{viewingReport.zoneName} | {viewingReport.date} | {viewingReport.preparedBy}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => printReport(viewingReport, changes)}
                                        className="px-4 py-2 rounded-lg font-bold text-gray-900 text-sm"
                                        style={{ backgroundColor: 'var(--primary-gold)' }}>
                                        ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4
                                    </button>
                                    <button onClick={() => setViewingReport(null)}
                                        className="text-white text-3xl hover:text-red-500 transition leading-none">Ã—</button>
                                </div>
                            </div>
                            <div className="p-6 space-y-4">
                                <div className="grid grid-cols-3 gap-4">
                                    {[['ğŸ‘· Ø§Ù„Ø¹Ù…Ø§Ù„', viewingReport.workers||0], ['ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ†', viewingReport.technicians||0], ['ğŸ“ˆ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', changes.length]].map(([l,v]) => (
                                        <div key={l} className="bg-gray-700 p-4 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-white">{v}</div>
                                            <div className="text-sm text-gray-400">{l}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-gray-700 p-4 rounded-lg">
                                    <h4 className="text-white font-bold mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ({changes.length})</h4>
                                    {changes.length === 0 ? (
                                        <p className="text-gray-400 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {changes.map((c, i) => (
                                                <div key={i} className="bg-gray-600 p-3 rounded-lg grid grid-cols-2 gap-2 text-sm">
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> Ø¨Ù„ÙˆÙƒ {c.block} - Ø¨ÙŠØª {c.house}</div>
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ù‚Ø³Ù…:</span> {c.department}</div>
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ø¹Ù…Ù„:</span> {c.task}</div>
                                                    <div className="text-gray-300">
                                                        <span className="text-red-400">{getStatusLabel(c.oldStatus)}</span>
                                                        {' â†’ '}
                                                        <span className="text-green-400">{getStatusLabel(c.newStatus)}</span>
                                                    </div>
                                                    <div className="text-gray-400 text-xs col-span-2">{c.timestampDisplay || c.timestamp}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {viewingReport.notes && (
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <p className="text-gray-300"><span className="font-bold text-white">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> {viewingReport.notes}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙŠØ± =====
            if (currentUser.role === 'manager') {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto modal-inner">
                            <div className="sticky top-0 bg-gray-800 p-5 border-b border-gray-700 flex items-center justify-between">
                                <h3 className="text-2xl font-bold text-white">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => { loadAllReports(); loadAllZonesChanges(); }}
                                        className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 font-bold">
                                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                                    </button>
                                    <button onClick={onClose} className="text-white text-3xl hover:text-red-500 transition leading-none">Ã—</button>
                                </div>
                            </div>
                            <div className="p-4 space-y-4">
                                {/* ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ… */}
                                <div className="bg-gray-700 p-4 rounded-lg">
                                    <h4 className="text-base font-bold text-white mb-3">ğŸ“ˆ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ… - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙˆÙ†Ø§Øª ({allZonesChanges.length})</h4>
                                    {allZonesChanges.length === 0 ? (
                                        <p className="text-gray-400 text-center py-3 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª â€” Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ«</p>
                                    ) : (
                                        <div className="space-y-2 max-h-56 overflow-y-auto">
                                            {allZonesChanges.map((c, i) => (
                                                <div key={i} className="bg-gray-600 p-3 rounded-lg grid grid-cols-2 gap-1 text-xs">
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ø²ÙˆÙ†:</span> {c.zoneName||'-'}</div>
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³:</span> {c.username||'-'}</div>
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> Ø¨Ù„ÙˆÙƒ {c.block} - Ø¨ÙŠØª {c.house}</div>
                                                    <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ø¹Ù…Ù„:</span> {c.task}</div>
                                                    <div className="col-span-2">
                                                        <span className="text-red-400">{getStatusLabel(c.oldStatus)}</span>
                                                        {' â†’ '}
                                                        <span className="text-green-400">{getStatusLabel(c.newStatus)}</span>
                                                        <span className="text-gray-500 mr-2 text-xs">{c.timestampDisplay||''}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {/* Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ¯Ù‘Ø±Ø© */}
                                <div className="bg-gray-700 p-4 rounded-lg">
                                    <h4 className="text-base font-bold text-white mb-3">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ¯Ù‘Ø±Ø©</h4>
                                    {isLoadingReports ? (
                                        <div className="text-center py-6">
                                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500 mx-auto mb-2"></div>
                                            <p className="text-gray-400 text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase...</p>
                                        </div>
                                    ) : allReports.length === 0 ? (
                                        <div className="text-center py-6">
                                            <div className="text-4xl mb-2">ğŸ“­</div>
                                            <p className="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± â€” Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ«</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {allReports.map((report, idx) => (
                                                <div key={idx} className="bg-gray-600 p-4 rounded-lg">
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div>
                                                            <h4 className="text-base font-bold text-white">{report.zoneName||'Ø²ÙˆÙ†'}</h4>
                                                            <div className="flex flex-wrap gap-2 text-xs text-gray-400 mt-1">
                                                                <span>ğŸ“… {report.date}</span>
                                                                <span>â° {report.time}</span>
                                                                <span>ğŸ‘¤ {report.preparedBy}</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 mr-2">
                                                            <button onClick={() => setViewingReport(report)}
                                                                className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                                            <button onClick={() => printReport(report, getReportChanges(report))}
                                                                className="px-3 py-1.5 rounded-lg text-xs font-bold text-gray-900"
                                                                style={{ backgroundColor: 'var(--primary-gold)' }}>ğŸ–¨ï¸</button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {[['ğŸ‘·', report.workers||0, 'Ø¹Ù…Ø§Ù„'], ['ğŸ”§', report.technicians||0, 'ÙÙ†ÙŠÙŠÙ†'], ['ğŸ“ˆ', getReportChanges(report).length || report.totalChanges || 0, 'ØªØºÙŠÙŠØ±']].map(([ic,v,l]) => (
                                                            <div key={l} className="bg-gray-700 p-2 rounded-lg text-center">
                                                                <div className="text-lg font-bold text-white">{v}</div>
                                                                <div className="text-xs text-gray-400">{ic} {l}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {report.notes && <p className="text-gray-400 text-xs mt-2">ğŸ“ {report.notes}</p>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ =====
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-5 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-2xl font-bold text-white">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                                {!isSubmitted && <p className="text-yellow-400 text-sm mt-1">â° Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {timeLeft}</p>}
                                {isSubmitted && <p className="text-green-400 text-sm mt-1">âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</p>}
                            </div>
                            <button onClick={onClose} className="text-white text-3xl hover:text-red-500 transition leading-none">Ã—</button>
                        </div>

                        <div className="p-6 space-y-5">
                            {!isSubmitted && (
                                <div className="bg-gray-700 p-5 rounded-lg">
                                    <h4 className="text-lg font-bold text-white mb-4">Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©</h4>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-gray-300 mb-2 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„</label>
                                            <input type="number" value={workers} onChange={e => setWorkers(e.target.value)}
                                                className="w-full px-4 py-3 bg-gray-600 text-white rounded-lg" placeholder="0" />
                                        </div>
                                        <div>
                                            <label className="block text-gray-300 mb-2 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</label>
                                            <input type="number" value={technicians} onChange={e => setTechnicians(e.target.value)}
                                                className="w-full px-4 py-3 bg-gray-600 text-white rounded-lg" placeholder="0" />
                                        </div>
                                    </div>
                                    <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={2}
                                        className="w-full px-4 py-3 bg-gray-600 text-white rounded-lg resize-none mb-4"
                                        placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." />
                                    <div className="flex gap-3">
                                        <button onClick={handleSaveDraft}
                                            className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                            ğŸ’¾ Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©
                                        </button>
                                        <button onClick={handleSubmit}
                                            className="flex-1 py-3 rounded-lg font-bold text-gray-900"
                                            style={{ backgroundColor: 'var(--primary-gold)' }}>
                                            ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                        </button>
                                    </div>
                                </div>
                            )}

                            {isSubmitted && (
                                <div className="bg-gray-700 p-5 rounded-lg text-center">
                                    <div className="text-4xl mb-2">âœ…</div>
                                    <p className="text-green-400 font-bold mb-4">ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                                    <div className="flex gap-3 justify-center">
                                        <button onClick={() => {
                                            const r = dataManager.reportHistory[0] || {};
                                            setViewingReport({...r, preparedBy: r.preparedBy || currentUser.name, zoneName: r.zoneName || dataManager.getZoneData()?.name, changes: r.changes || todayChanges});
                                        }}
                                            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                                            ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                        </button>
                                        <button onClick={() => {
                                            const r = dataManager.reportHistory[0] || {};
                                            printReport({...r, preparedBy: r.preparedBy || currentUser.name, zoneName: r.zoneName || dataManager.getZoneData()?.name}, r.changes || todayChanges);
                                        }}
                                            className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="bg-gray-700 p-5 rounded-lg">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="text-lg font-bold text-white">ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ… ({todayChanges.length})</h4>
                                    <button onClick={updateTodayChanges}
                                        className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                                </div>
                                {todayChanges.length === 0 ? (
                                    <p className="text-gray-400 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                                ) : (
                                    <div className="space-y-2 max-h-72 overflow-y-auto">
                                        {todayChanges.map((c, i) => (
                                            <div key={i} className="bg-gray-600 p-3 rounded-lg grid grid-cols-2 gap-2 text-sm">
                                                <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> Ø¨Ù„ÙˆÙƒ {c.block} - Ø¨ÙŠØª {c.house}</div>
                                                <div className="text-gray-300"><span className="font-bold text-white">Ø§Ù„Ø¹Ù…Ù„:</span> {c.task}</div>
                                                <div className="text-gray-300">
                                                    <span className="text-red-400">{getStatusLabel(c.oldStatus)}</span>
                                                    {' â†’ '}
                                                    <span className="text-green-400">{getStatusLabel(c.newStatus)}</span>
                                                </div>
                                                <div className="text-gray-400 text-xs">{c.timestampDisplay || c.timestamp}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="bg-gray-700 p-5 rounded-lg">
                                <h4 className="text-lg font-bold text-white mb-3">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                                {dataManager.reportHistory.length === 0 ? (
                                    <p className="text-gray-400 text-center py-5">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø§Ø¨Ù‚Ø©</p>
                                ) : (
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {dataManager.reportHistory.map((r, i) => (
                                            <div key={i} className="bg-gray-600 p-3 rounded-lg flex items-center justify-between">
                                                <div className="text-sm text-gray-300">
                                                    <span className="font-bold text-white">{r.date}</span>
                                                    <span className="mx-2 text-gray-500">|</span>
                                                    {r.changes?.length ?? r.totalChanges ?? 0} ØªØºÙŠÙŠØ±
                                                    <span className="mx-2 text-gray-500">|</span>
                                                    {r.workers||0} Ø¹Ù…Ø§Ù„
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setViewingReport(r)}
                                                        className="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-500">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                                    <button onClick={() => printReport(r, r.changes || [])}
                                                        className="text-xs px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-400">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }


        // ==================== Approval Modal ====================
        function ApprovalModal({ currentUser, onClose }) {
            const [requests, setRequests] = useState([]);
            const [refreshKey, setRefreshKey] = useState(0);

            useEffect(() => {
                loadRequests();
            }, [refreshKey]);

            const loadRequests = () => {
                if (currentUser.role === 'manager') {
                    // Show all pending requests
                    setRequests(dataManager.getPendingRequests());
                } else {
                    // Show engineer's own requests
                    setRequests(dataManager.getMyRequests(currentUser.name));
                }
            };

            const handleApprove = (requestId) => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                    const success = dataManager.approveRequest(requestId);
                    if (success) {
                        setRefreshKey(prev => prev + 1);
                        alert('âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­\nØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØª');
                    } else {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©');
                    }
                }
            };

            const handleReject = (requestId) => {
                const reason = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
                if (reason !== null) {
                    const success = dataManager.rejectRequest(requestId, reason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ù…Ø­Ø¯Ø¯');
                    if (success) {
                        setRefreshKey(prev => prev + 1);
                        alert('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨\nØ³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³');
                    } else {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¶');
                    }
                }
            };

            const getStatusBadge = (status) => {
                if (status === 'pending') {
                    return <span className="px-3 py-1 bg-yellow-600 text-white rounded-full text-sm">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>;
                } else if (status === 'approved') {
                    return <span className="px-3 py-1 bg-green-600 text-white rounded-full text-sm">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>;
                } else {
                    return <span className="px-3 py-1 bg-red-600 text-white rounded-full text-sm">âŒ Ù…Ø±ÙÙˆØ¶</span>;
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-2xl font-bold text-white">
                                    {currentUser.role === 'manager' ? 'âœ‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'ğŸ“ Ø·Ù„Ø¨Ø§ØªÙŠ'}
                                </h3>
                                {currentUser.role === 'manager' && (
                                    <p className="text-gray-400 text-sm mt-1">
                                        {requests.length} Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                    </p>
                                )}
                            </div>
                            <button
                                onClick={onClose}
                                className="text-white text-3xl hover:text-red-500 transition"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="p-6">
                            {requests.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">
                                        {currentUser.role === 'manager' ? 'âœ…' : 'ğŸ“­'}
                                    </div>
                                    <p className="text-gray-400 text-lg">
                                        {currentUser.role === 'manager' 
                                            ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙˆØ§ÙÙ‚Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'
                                            : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø±Ø³Ù„Ø©'
                                        }
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {requests.map((request) => (
                                        <div key={request.id} className="bg-gray-700 p-6 rounded-lg">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <h4 className="text-xl font-bold text-white">
                                                            {request.zoneName} - Ø¨Ù„ÙˆÙƒ {request.block} - Ø¨ÙŠØª {request.house}
                                                        </h4>
                                                        {getStatusBadge(request.status)}
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 text-sm text-gray-300 mb-3">
                                                        <div>ğŸ“… {request.timestampDisplay}</div>
                                                        <div>ğŸ‘¤ {request.username}</div>
                                                        <div>ğŸ“‚ {request.departmentName}</div>
                                                        <div>ğŸ”§ {request.taskName}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-gray-600 p-4 rounded-lg mb-4">
                                                <div className="flex items-center justify-center gap-8">
                                                    <div className="text-center">
                                                        <div className="text-sm text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                                                        <div className={`text-lg font-bold ${
                                                            request.oldStatus === 'completed' ? 'text-green-400' :
                                                            request.oldStatus === 'in-progress' ? 'text-yellow-400' :
                                                            'text-red-400'
                                                        }`}>
                                                            {request.oldStatusText}
                                                        </div>
                                                    </div>
                                                    <div className="text-3xl">â†’</div>
                                                    <div className="text-center">
                                                        <div className="text-sm text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
                                                        <div className={`text-lg font-bold ${
                                                            request.newStatus === 'completed' ? 'text-green-400' :
                                                            request.newStatus === 'in-progress' ? 'text-yellow-400' :
                                                            'text-red-400'
                                                        }`}>
                                                            {request.newStatusText}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {request.status === 'rejected' && request.rejectionReason && (
                                                <div className="bg-red-900 bg-opacity-30 border border-red-500 p-3 rounded-lg mb-4">
                                                    <p className="text-red-300 text-sm">
                                                        <span className="font-bold">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</span> {request.rejectionReason}
                                                    </p>
                                                </div>
                                            )}

                                            {currentUser.role === 'manager' && request.status === 'pending' && (
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={() => handleApprove(request.id)}
                                                        className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold"
                                                    >
                                                        âœ… Ù…ÙˆØ§ÙÙ‚Ø©
                                                    </button>
                                                    <button
                                                        onClick={() => handleReject(request.id)}
                                                        className="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold"
                                                    >
                                                        âŒ Ø±ÙØ¶
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== User Management Modal ====================
        function UserManagementModal({ currentUser, onClose }) {
            const [showAddUser, setShowAddUser] = useState(false);
            const [showChangePassword, setShowChangePassword] = useState(null);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <h3 className="text-2xl font-bold text-white">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
                            <button
                                onClick={onClose}
                                className="text-white text-3xl hover:text-red-500 transition"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="mb-6">
                                <div className="bg-gray-700 p-4 rounded-lg mb-4">
                                    <h4 className="text-white font-bold mb-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                                    <p className="text-gray-300">Ø§Ù„Ø§Ø³Ù…: {currentUser.name}</p>
                                    <p className="text-gray-300">
                                        Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: {
                                            currentUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' :
                                            currentUser.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' :
                                            'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹'
                                        }
                                    </p>
                                </div>

                                {(currentUser.role === 'admin' || currentUser.role === 'manager') && (
                                    <>
                                        <button
                                            onClick={() => setShowAddUser(true)}
                                            className="w-full py-3 rounded-lg font-bold text-gray-900 mb-4"
                                            style={{ backgroundColor: 'var(--primary-gold)' }}
                                        >
                                            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                                        </button>

                                        <div className="space-y-3">
                                            <h4 className="text-white font-bold mb-3">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h4>
                                            {userManager.getVisibleUsers().map(user => (
                                                <div key={user.id} className="bg-gray-700 p-4 rounded-lg">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div>
                                                            <p className="text-white font-bold">{user.name}</p>
                                                            <p className="text-gray-400 text-sm">
                                                                {user.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' : 'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹'}
                                                            </p>
                                                            {user.role === 'engineer' && user.department && (
                                                                <div className="mt-2 space-y-1">
                                                                    <p className="text-gray-300 text-sm">
                                                                        <span className="font-semibold">Ø§Ù„ØªØ®ØµØµ:</span> {
                                                                            user.department === 'civil' ? 'ğŸ—ï¸ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©' :
                                                                            user.department === 'electrical' ? 'âš¡ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©' :
                                                                            'ğŸ”§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©'
                                                                        }
                                                                    </p>
                                                                    {user.assignedZones && user.assignedZones.length > 0 && (
                                                                        <div className="text-gray-300 text-sm">
                                                                            <span className="font-semibold">Ø§Ù„Ø²ÙˆÙ†Ø§Øª:</span>
                                                                            <div className="mr-4 mt-1 space-y-1">
                                                                                {user.assignedZones.map(zoneId => (
                                                                                    <div key={zoneId}>
                                                                                        <span className="text-blue-400">â€¢ {
                                                                                            zoneId === 1 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' :
                                                                                            zoneId === 2 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                                                                            'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³'
                                                                                        }</span>
                                                                                        {user.zoneBlocks && user.zoneBlocks[zoneId] && (
                                                                                            <span className="text-gray-400 mr-2">
                                                                                                (Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª: {user.zoneBlocks[zoneId].sort((a, b) => a - b).join(', ')})
                                                                                            </span>
                                                                                        )}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    {/* Support old format */}
                                                                    {user.assignedZone && !user.assignedZones && (
                                                                        <>
                                                                            <p className="text-gray-300 text-sm">
                                                                                <span className="font-semibold">Ø§Ù„Ø²ÙˆÙ†:</span> {
                                                                                    user.assignedZone === 1 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' :
                                                                                    user.assignedZone === 2 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                                                                    'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³'
                                                                                }
                                                                            </p>
                                                                            {user.assignedBlocks && user.assignedBlocks.length > 0 && (
                                                                                <p className="text-gray-300 text-sm">
                                                                                    <span className="font-semibold">Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª:</span> {user.assignedBlocks.sort((a, b) => a - b).join(', ')}
                                                                                </p>
                                                                            )}
                                                                        </>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setShowChangePassword(user)}
                                                                className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                                title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                                            >
                                                                ğŸ”‘
                                                            </button>
                                                            {currentUser.role === 'admin' && (
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${user.name}ØŸ`)) {
                                                                            userManager.deleteUser(user.id);
                                                                            window.location.reload();
                                                                        }
                                                                    }}
                                                                    className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                                                    title="Ø­Ø°Ù"
                                                                >
                                                                    ğŸ—‘ï¸
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="bg-gray-700 p-4 rounded-lg">
                                <h4 className="text-white font-bold mb-3">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                                <p className="text-gray-300 text-sm mb-3">
                                    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
                                </p>
                                <button
                                    onClick={() => {
                                        const code = userManager.exportUsersCode();
                                        const textarea = document.createElement('textarea');
                                        textarea.value = code;
                                        document.body.appendChild(textarea);
                                        textarea.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(textarea);
                                        
                                        alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!\n\n` +
                                              `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${userManager.users.length}\n\n` +
                                              `ğŸ“± ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø±:\n` +
                                              `1. Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù\n` +
                                              `2. Ø§Ø¶ØºØ· "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† ÙƒÙˆØ¯"\n` +
                                              `3. Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯\n\n` +
                                              `Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†Ø³ÙˆØ® ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¢Ù†!`);
                                    }}
                                    className="w-full py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-bold"
                                >
                                    ğŸ“¤ Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                                </button>
                            </div>

                            <div className="bg-gray-700 p-4 rounded-lg">
                                <h4 className="text-white font-bold mb-3">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (GitHub Gist)</h4>
                                <p className="text-gray-300 text-sm mb-3">
                                    {cloudSync.gistId 
                                        ? `âœ… Ù…ØªØµÙ„ Ø¨Ù€ Gist: ${cloudSync.gistId.substring(0, 8)}...`
                                        : 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø¹Ø¯ - Ø³ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„'
                                    }
                                </p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={async () => {
                                            const success = await cloudSync.exportData();
                                            if (success) {
                                                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                                            } else {
                                                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±');
                                            }
                                        }}
                                        className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    >
                                        ğŸ“¥ ØªØµØ¯ÙŠØ± CSV
                                    </button>
                                    <button
                                        onClick={async () => {
                                            const data = await cloudSync.syncData();
                                            if (data) {
                                                alert(`âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©\n\nğŸ“Š Ø§Ù„Ø£Ù†Ø´Ø·Ø©: ${data.activities?.length || 0}\nğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: ${data.reports?.length || 0}\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${data.users?.length || 0}`);
                                            } else {
                                                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                                            }
                                        }}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        ğŸ”„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
                                    </button>
                                </div>
                                {cloudSync.gistId && (
                                    <button
                                        onClick={() => {
                                            const gistUrl = `https://gist.github.com/${cloudSync.gistId}`;
                                            navigator.clipboard.writeText(gistUrl);
                                            alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Gist!\n\nğŸ”— ${gistUrl}\n\nğŸ’¡ Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰\nÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø±: Ø§Ø¶ØºØ· "ğŸ”— Ø±Ø¨Ø· Ù…Ø¹ Gist Ù…ÙˆØ¬ÙˆØ¯"`);
                                        }}
                                        className="w-full py-3 mt-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
                                    >
                                        ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Gist
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {showAddUser && (
                        <AddUserModal 
                            currentUserRole={currentUser.role}
                            onClose={() => setShowAddUser(false)}
                            onAdd={() => {
                                setShowAddUser(false);
                                window.location.reload();
                            }}
                        />
                    )}

                    {showChangePassword && (
                        <ChangePasswordModal
                            user={showChangePassword}
                            onClose={() => setShowChangePassword(null)}
                            onSuccess={() => {
                                setShowChangePassword(null);
                                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
                            }}
                        />
                    )}
                </div>
            );
        }

        // ==================== Add User Modal ====================
        function AddUserModal({ currentUserRole, onClose, onAdd }) {
            const [name, setName] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('engineer');
            const [department, setDepartment] = useState('civil');
            const [assignedZones, setAssignedZones] = useState([]);
            const [zoneBlocks, setZoneBlocks] = useState({});

            const zones = [
                { id: 1, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' },
                { id: 2, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' },
                { id: 5, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³' }
            ];

            const departments = [
                { id: 'civil', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©', icon: 'ğŸ—ï¸' },
                { id: 'electrical', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', icon: 'âš¡' },
                { id: 'mechanical', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', icon: 'ğŸ”§' }
            ];

            const toggleZone = (zoneId) => {
                if (assignedZones.includes(zoneId)) {
                    // Remove zone
                    setAssignedZones(assignedZones.filter(z => z !== zoneId));
                    const newZoneBlocks = { ...zoneBlocks };
                    delete newZoneBlocks[zoneId];
                    setZoneBlocks(newZoneBlocks);
                } else {
                    // Add zone
                    setAssignedZones([...assignedZones, zoneId]);
                    setZoneBlocks({ ...zoneBlocks, [zoneId]: [] });
                }
            };

            const toggleBlock = (zoneId, blockNumber) => {
                const blocks = zoneBlocks[zoneId] || [];
                if (blocks.includes(blockNumber)) {
                    setZoneBlocks({
                        ...zoneBlocks,
                        [zoneId]: blocks.filter(b => b !== blockNumber)
                    });
                } else {
                    setZoneBlocks({
                        ...zoneBlocks,
                        [zoneId]: [...blocks, blockNumber]
                    });
                }
            };

            const selectAllBlocks = (zoneId) => {
                const allBlocks = ZONES_DATA[zoneId]?.blocks.map(b => b.number) || [];
                setZoneBlocks({
                    ...zoneBlocks,
                    [zoneId]: allBlocks
                });
            };

            const clearAllBlocks = (zoneId) => {
                setZoneBlocks({
                    ...zoneBlocks,
                    [zoneId]: []
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (role === 'engineer') {
                    if (assignedZones.length === 0) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø²ÙˆÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³');
                        return;
                    }
                    
                    // Check if all zones have blocks assigned
                    for (const zoneId of assignedZones) {
                        if (!zoneBlocks[zoneId] || zoneBlocks[zoneId].length === 0) {
                            alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¨Ù„ÙˆÙƒØ§Øª Ù„Ù„Ø²ÙˆÙ† ${zoneId}`);
                            return;
                        }
                    }
                }
                
                userManager.addUser({
                    name,
                    username,
                    password,
                    role,
                    department: role === 'engineer' ? department : null,
                    assignedZones: role === 'engineer' ? assignedZones : null,
                    zoneBlocks: role === 'engineer' ? zoneBlocks : null,
                    hidden: false
                });

                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                      `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
                      `ğŸ”‘ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}\n` +
                      `ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${password}\n\n` +
                      `â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...\n` +
                      `Ø§Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†ÙŠ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±`);
                
                onAdd();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
                    <div className="bg-gray-800 rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-white mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-white mb-2">Ø§Ù„Ø§Ø³Ù…</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-white mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-white mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-white mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                <select
                                    value={role}
                                    onChange={(e) => setRole(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                >
                                    {currentUserRole === 'admin' && (
                                        <option value="manager">Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹</option>
                                    )}
                                    <option value="engineer">Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹</option>
                                </select>
                            </div>

                            {role === 'engineer' && (
                                <>
                                    <div>
                                        <label className="block text-white mb-2">Ø§Ù„ØªØ®ØµØµ</label>
                                        <select
                                            value={department}
                                            onChange={(e) => setDepartment(e.target.value)}
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        >
                                            {departments.map(dept => (
                                                <option key={dept.id} value={dept.id}>
                                                    {dept.icon} {dept.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-white mb-2">Ø§Ù„Ø²ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø²ÙˆÙ†)</label>
                                        <div className="grid grid-cols-3 gap-3 p-4 bg-gray-700 rounded-lg">
                                            {zones.map(zone => (
                                                <button
                                                    key={zone.id}
                                                    type="button"
                                                    onClick={() => toggleZone(zone.id)}
                                                    className={`p-4 rounded-lg text-center transition ${
                                                        assignedZones.includes(zone.id)
                                                            ? 'bg-green-600 text-white ring-2 ring-green-400'
                                                            : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                                    }`}
                                                >
                                                    <div className="font-bold">{zone.name}</div>
                                                    {assignedZones.includes(zone.id) && (
                                                        <div className="text-sm mt-1">âœ…</div>
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {assignedZones.map(zoneId => (
                                        <div key={zoneId} className="bg-gray-700 p-4 rounded-lg">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="text-white font-bold">
                                                    Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© - {zones.find(z => z.id === zoneId)?.name}
                                                </h4>
                                                <div className="flex gap-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => selectAllBlocks(zoneId)}
                                                        className="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                    >
                                                        ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => clearAllBlocks(zoneId)}
                                                        className="text-xs px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                                    >
                                                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-5 md:grid-cols-8 gap-2">
                                                {ZONES_DATA[zoneId]?.blocks.map(block => (
                                                    <button
                                                        key={block.number}
                                                        type="button"
                                                        onClick={() => toggleBlock(zoneId, block.number)}
                                                        className={`p-2 rounded-lg text-center transition text-sm ${
                                                            (zoneBlocks[zoneId] || []).includes(block.number)
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                                        }`}
                                                    >
                                                        <div className="font-bold">{block.number}</div>
                                                    </button>
                                                ))}
                                            </div>
                                            <p className="text-sm text-gray-400 mt-2">
                                                ØªÙ… ØªØ­Ø¯ÙŠØ¯ {(zoneBlocks[zoneId] || []).length} Ø¨Ù„ÙˆÙƒ
                                            </p>
                                        </div>
                                    ))}
                                </>
                            )}

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 py-3 rounded-lg font-bold text-gray-900"
                                    style={{ backgroundColor: 'var(--primary-gold)' }}
                                >
                                    Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== Change Password Modal ====================
        function ChangePasswordModal({ user, onClose, onSuccess }) {
            const [newPassword, setNewPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                userManager.updatePassword(user.id, newPassword);
                onSuccess();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
                    <div className="bg-gray-800 rounded-lg max-w-md w-full p-6">
                        <h3 className="text-2xl font-bold text-white mb-6">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                        <p className="text-gray-300 mb-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user.name}</p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-white mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    required
                                />
                            </div>

                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 py-3 rounded-lg font-bold text-gray-900"
                                    style={{ backgroundColor: 'var(--primary-gold)' }}
                                >
                                    ØªØºÙŠÙŠØ±
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== Render App ====================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- ===== PWA Install Banner ===== -->
    <div id="pwa-install-banner" style="display:none;">
        <div class="pwa-icon">AL</div>
        <div class="pwa-text">
            <div class="pwa-title">Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚ ALFARAH</div>
            <div class="pwa-sub" id="pwa-install-hint">Ø§Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</div>
        </div>
        <button class="pwa-btn" id="pwa-install-btn">ØªØ«Ø¨ÙŠØª</button>
        <button class="pwa-close" id="pwa-close-btn">Ã—</button>
    </div>

    <!-- ===== Service Worker ===== -->
    <script>
        // ---- Service Worker ----
        const SW_CODE = `
const CACHE = 'alfarah-v1';
const ASSETS = [
    './',
    'https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap',
    'https://unpkg.com/react@18/umd/react.production.min.js',
    'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
    'https://unpkg.com/@babel/standalone/babel.min.js',
    'https://cdn.tailwindcss.com'
];

self.addEventListener('install', e => {
    e.waitUntil(
        caches.open(CACHE).then(c => {
            // Cache main page only (CDN assets may fail due to CORS)
            return c.add('./').catch(() => {});
        })
    );
    self.skipWaiting();
});

self.addEventListener('activate', e => {
    e.waitUntil(
        caches.keys().then(keys =>
            Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        )
    );
    self.clients.claim();
});

self.addEventListener('fetch', e => {
    // Ù„Ù„Ù€ Firebase - Ù„Ø§ Ù†Ø¹ØªØ±Ø¶Ù‡
    if (e.request.url.includes('firebaseio.com') || 
        e.request.url.includes('googleapis.com/identitytoolkit')) {
        return;
    }
    e.respondWith(
        caches.match(e.request).then(cached => {
            if (cached) return cached;
            return fetch(e.request).then(res => {
                if (res && res.status === 200 && res.type === 'basic') {
                    const clone = res.clone();
                    caches.open(CACHE).then(c => c.put(e.request, clone));
                }
                return res;
            }).catch(() => cached || new Response('offline', {status: 503}));
        })
    );
});
`;

        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            const swBlob = new Blob([SW_CODE], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swURL, {scope: './'})
                .then(reg => console.log('âœ… SW registered'))
                .catch(err => console.warn('SW registration failed (normal in some browsers):', err));
        }

        // ---- PWA Install Prompt ----
        let deferredPrompt = null;
        const banner = document.getElementById('pwa-install-banner');
        const installBtn = document.getElementById('pwa-install-btn');
        const closeBtn = document.getElementById('pwa-close-btn');
        const hint = document.getElementById('pwa-install-hint');

        // Android / Chrome - Ø­Ø¯Ø« Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            banner.style.display = 'flex';
            hint.textContent = 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ';
        });

        // iOS Safari - Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙŠØ¯ÙˆÙŠØ©
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        if (isIOS && isSafari && !isStandalone) {
            setTimeout(() => {
                banner.style.display = 'flex';
                hint.textContent = 'Share â† Add to Home Screen';
                installBtn.textContent = 'ÙƒÙŠÙØŸ';
                installBtn.onclick = () => {
                    alert('Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ iPhone:\n\n1ï¸âƒ£ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© â†‘ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©\n2ï¸âƒ£ Ø§Ø®ØªØ± "Add to Home Screen"\n3ï¸âƒ£ Ø§Ø¶ØºØ· "Add"\n\nØ³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø´Ø§Ø´ØªÙƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙƒØ£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ');
                };
            }, 3000);
        }

        installBtn && installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                banner.style.display = 'none';
            }
        });

        closeBtn && closeBtn.addEventListener('click', () => {
            banner.style.display = 'none';
        });

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ù†Ø± Ø¥Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„
        if (isStandalone) {
            banner.style.display = 'none';
        }
    </script>
</body>
</html>
